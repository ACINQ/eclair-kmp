package fr.acinq.lightning.serialization

import fr.acinq.lightning.CltvExpiryDelta
import fr.acinq.lightning.Lightning
import fr.acinq.lightning.blockchain.BITCOIN_FUNDING_DEPTHOK
import fr.acinq.lightning.blockchain.WatchEventConfirmed
import fr.acinq.lightning.channel.*
import fr.acinq.lightning.channel.TestsHelper.processEx
import fr.acinq.lightning.channel.states.WaitForFundingConfirmedTestsCommon
import fr.acinq.lightning.tests.TestConstants
import fr.acinq.lightning.utils.UUID
import fr.acinq.lightning.utils.msat
import fr.acinq.lightning.wire.FundingLocked
import fr.acinq.lightning.wire.UpdateAddHtlc
import fr.acinq.secp256k1.Hex
import kotlin.test.Ignore
import kotlin.test.Test
import kotlin.test.assertIs
import kotlin.test.assertTrue

class CompatibilityTestsCommon {
    @Ignore
    @Test
    fun `generate data`() {
        // generate test data
        val (alice, bob, fundingTx) = run {
            val (alice0, bob0, txSigsBob) = WaitForFundingConfirmedTestsCommon.init(ChannelType.SupportedChannelType.AnchorOutputs, TestConstants.aliceFundingAmount, TestConstants.bobFundingAmount, TestConstants.pushAmount)
            val (alice1, actions1) = alice0.processEx(ChannelEvent.MessageReceived(txSigsBob))
            assertIs<WaitForFundingConfirmed>(alice1)
            val fundingTx = actions1.find<ChannelAction.Blockchain.PublishTx>().tx
            Triple(alice1, bob0, fundingTx)
        }
        val bin = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob)
        println("wait_for_funding_confirmed: ${bin.data}")

        val (bob1, actionsBob) = bob.processEx(ChannelEvent.WatchReceived(WatchEventConfirmed(bob.channelId, BITCOIN_FUNDING_DEPTHOK, 42, 0, fundingTx)))
        val fundingLocked = actionsBob.findOutgoingMessage<FundingLocked>()
        assertTrue(bob1 is WaitForFundingLocked)

        val bin1 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob1)
        println("wait_for_funding_locked: ${bin1.data}")

        val (alice1, actionsAlice) = alice.processEx(ChannelEvent.MessageReceived(fundingLocked))
        assertTrue(alice1 is WaitForFundingConfirmed && alice1.deferred == fundingLocked)

        assertTrue(actionsAlice.isEmpty()) // alice waits until she sees on-chain confirmations herself
        val (alice2, actionsAlice2) = alice1.processEx(ChannelEvent.WatchReceived(WatchEventConfirmed(alice.channelId, BITCOIN_FUNDING_DEPTHOK, 0, 42, fundingTx)))
        val fundingLockedAlice = actionsAlice2.findOutgoingMessage<FundingLocked>()
        val (bob2, _) = bob1.processEx(ChannelEvent.MessageReceived(fundingLockedAlice))
        assertTrue(bob2 is Normal)

        val bin2 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob2)
        println("normal: ${bin2.data}")

        val add1 = CMD_ADD_HTLC(
            10_000.msat,
            Lightning.randomBytes32(),
            CltvExpiryDelta(144).toCltvExpiry(TestConstants.defaultBlockHeight.toLong()),
            TestConstants.emptyOnionPacket,
            UUID.randomUUID()
        )
        val add2 = CMD_ADD_HTLC(
            10_000.msat,
            Lightning.randomBytes32(),
            CltvExpiryDelta(144).toCltvExpiry(TestConstants.defaultBlockHeight.toLong()),
            TestConstants.emptyOnionPacket,
            UUID.randomUUID()
        )
        val (alice3, actionsAlice3) = alice2.processEx(ChannelEvent.ExecuteCommand(add1))
        val (_, actionsAlice4) = alice3.processEx(ChannelEvent.ExecuteCommand(add2))
        val htlc1 = actionsAlice3.findOutgoingMessage<UpdateAddHtlc>()
        val htlc2 = actionsAlice4.findOutgoingMessage<UpdateAddHtlc>()

        val (bob3, _) = bob2.processEx(ChannelEvent.MessageReceived(htlc1))
        val (bob4, _) = bob3.processEx(ChannelEvent.MessageReceived(htlc2))
        val (bob5, _) = bob4.processEx(ChannelEvent.ExecuteCommand(add1))
        val (bob6, _) = bob5.processEx(ChannelEvent.ExecuteCommand(add2))
        assertTrue(bob6 is Normal)

        val bin3 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob6)
        println("normal_with_htlcs: ${bin3.data}")
    }

    @Test
    fun `read compatibility test data`() {
        // data was generated with lightning-kmp v1.4.2
        // README: it this test fails it means that we cannot decrypt and/or deserialize data created with on older version of the app !!
        val waitForFundingConfirmed = Hex.decode(
            "e7b7c9d7aea6bdfcc63cf2e943122358f6f7844d849747afed182a23a6659c6363450073c6331549f0a14fe0015f069b7b2925511600a144e9ea22e9fbf9223c850ae1864b5056f0de1d75b2f13a8038c7568e9f75e4e90a2c4f8b39f359a03d090cf2fa47ca0020bcb372d5cd112ced10e7c7d3adc4bc92f2bdc46f2ae2f0bfbbc7bfae1ad183bf3c94deab04a74b3588991f35342b39b838c1896db9e9295458cfca0bbf3fc3b95469a094203b0c625ccf5b30ebf53f3e674268af1208b865fb49be550a4924e09fe3eeb6d83519debff33a15d16bdbc5365269d7277a35e041fcf2002899df542563cf793c38519d0f04bc0cc0a84108b182490d92b5bc260c8574a577cbfc1776b3b18429514c0de8d187d2533b2f99e5eeba972136a0537173e993922916ac4c87a9c3deae9e8c38f60695a04975286ed352cdee061015f7a0daada139d0abd1bc8a86ae9c22295bdfbaaf49d2dd2f8aa494b032027fb21b569f0e34cf469568a2f7c69cfad2f810e677cec6ea9d6d63e453682ce264ceb2904a99426d807b5e4f9b7524b3f9adb5ebeeac541ac01feed925f73546b88960235f91148d5fb7b3b5c21d39c64aeef4ffcbb2c17c3c76e81a0017169268ec3a400d92e4387e83c41c85d0fbe01284e68b851c0ffaa4838d8257df8fa197f20c4811c61884fbd49d7ca66dddabfc5962297694ffbe58323f958e9317de1bafb3e451e59e45523bc440c91bc98431718a7e9b7cf0ee14d7d2bc35bf3980f39ee0a337041560b56fe320081601fab4ae4751dae5d83a618baf484f462bd06212a12e6338178e997ad51acfb2e4da11c870598668ee34c708b1b8702e6d477ddac4b1605d039c080a0121ce843bb119254126133b0876753089d3e4d31d1e1237294fb6bae74689755a93f43258f34a3b30c72f4f7e16652cf72aa7f218f8fd66b63d9a0f2654e91ee814eaf2aac5647426a273550f4a1d58f3c6d41931f44321a9c9c0a5017829036d6677336e73befcddf7168283f654ecdb3b19acab7fd0b8d6dc36a5492d0f02803f322bc5a5078ab97795023e304e70d6fd2ea549107f2d9855fdfdcdec8d2cf13c963ae3d6abf7207312f47e81f754053bf5035ef7c6d7d357e8ff7af76117e9ff4d3f3006df479baa5578f3b0a2e5b265d727fc1c14573d36c11418581cc659c49941a49ef16abf1a595910183615ebc9e377e38365df98209d8d91420569bf99ab98cc31d5ef9584a4a0fd38ed744c7b4946b15e72b0fa2a4c825c940086ef56e62e6eb956be5c757fd7f146bbcbfff0d8ba11e67ade3b570b07a2440fca4deba0d58e8383f5efc6d328cf56127cd6a0a32e3764c3889f6c88abbef342cc5959238e7d21b505abbe3e13f520e6575dc0a2603654c67a690a99e32c2846484982c11a7909fa6c3de1b4a6b88536d719151d85bca9a5c587d4e088430fa3017405b5b2d320ebc9068a264f37a87ce6939c046d0a93dd25429a5267d3eca4edee87a134a453783fbbb1134c3c9bd9e8d5542af8bb74df35c1363dc665646e805dce08b5f94c7e66c96df7acb484799f35d26fee58a430b564a71b8ed60477071ff9c6ae43906fab50bf305da2dd2169c8373e2b9cf4c4f3edb88e5e98bca2baff92caef6d4ba173308fd11741bfff6be785f31df4dfd4fbd5451b53c3800c1574d22cc9d239ac3c49b08858ad25d21f761e79cc94e73096feef84ab7d9a2efae48846393db857b5e87decb1843ef6806151d30157a564fecf023ca4ef54607515dc665b623d577caf0ddbc33d77c096fa3b2cf581751dc5e36107e4b1735edfbfa1772c924f12d4cf8db6dc00f792c4aadf02bb9044ab8dc91ab568e680f1dc6976ec54bb7802fd919fad5c0992edcd478c45d1d0320b468ff9a75a8f4c0aba1b2c4079774225fc2625d35954463f0656ce6048d3723adbc74694e12ee00f41c706febf8c632d24d3fb2b1efe5624571192e4805208f57b2afb124dabdc1e8752ae71d3961b6932c339c9b8449e46a66a86d93a8e13f74a824a753df2201dfdf30dda6c1e49e868add438189375b77ef6122dbb44fd09f3cfafeb2969bf60d62f8b5b38faf7c90d501bcadbfba9e9f4863b669dc2c2ae983938c8bdbb185877048919369226ac4c35e5cf3f29f36fae6b60d6a3ad6da8b556c31cb4ac1be29d3dbcb450da6df277fa6222a2847df4f863d894d86c9fb494903e0cfbf98e258ec9de86b640aabc07720c230e6e5b28acc538c0742f5cb3c689197ac46b5725e4024c76743fd721f2d1da9ac1313a053aced007910d953ebbe75d189959404dd8c8d416ee990b3f3e25b8ff4b6c86fbed8c5dd2ae1092e070e9dce79bfe181527c35176a1f6b74c85c1a26669d9934c1abe6c5409b0f876aed91801ee1c28cd1c0d5847ea1aa35b4ec4d22b313637d6a735295d02a7d8a6991c1165f1fe04395296ae10f601f203d7fa99637e37c22ece53eab2ce05cf3a85309a3780cc7d11d432f3fb1925c19d4bc2debc07dfb96b69d40f2b101522e4831ecc8759492e4dbb787829c90f47f0779b0ff081c4538cf7e33f8842fe4d8155549cc5a51099f942bd5ba09dc8983ab2adf9e2ffbe88664474b55e0ca097efbbf328a59448521fe0c715d3429e094c84e4677814cd9d9fe95dcbde91c5352530c1de5a0afaa051ef7e3aafa4b11add1378d19d4e04d37141dbebcbcba6cd2dde265b85e26109151ef28102c7d24351ffe5ea8baec4a069f23851635b9aa5923f0c62ed4d05d5cc7f889d9a447e75654206e4265cc1dd79042b0c6e8b930ec9121576b27e946c06f7e259259909ea84d043d682066fb451f670e4788fed55fdc815957bd7564eda24f7923ce9e7d021b4ed1d25217493e45a02b5f312885e2ba0d1f9a53ff96627d64c9d583d48074b77072ff14b3588dd1a2c300eb424dce0976b34d6e2cbb9bebb80d61529c0b3fa5f6d73546a96f323491848e752e310c7894298512d2cc2575bca16e1d7e05c196d57865a0d6fd621feb9adc676baba4b5e672d26c867d0664f083e3eff7dad1f7f3b7c02435f4e9e8eae04199daf05721614349728a7d563d781785c3264a64578cfedb2e13e7e9df51903c25cd03e965e66695ec6a347a56b3b97300a30ebae40d97ed6d709142d8bb6dee3507b9a1b0549ab020f88934d46976727dc239049b8a59fedce1bc34dc25f990abc34f4d5f527bddd89d302c092f6aa5430fe6682598876f3332187804995a70de4bc16161c7484f3f8e5350f0de7b1f35c4ffe2b42a0b30896b8e949b671c2fc80035cfa9fdc0c1abf4ae2f7fc1a77e0bedb225ca884f52487da23ffc65c29e522fce56cf9bdc1c41de89e38773656202594b17182278d810bdfbbd1f70368ccdce6f882c3a90d28a4cfb09b134381e6a6b35b6f1d44125570f4f1df269b2b2b76f687d53b4901146b3af72f860cefb1811a183e3ff8773b3d0adc6cce27f55548d2f52e3c16d9175fe4c431013341b6f929fd17d36a5e415b0994c2dd1f2a0d017e81679e3394741489ecedba0143cde8071b21ea8896bd33f297ae4df81b9edc82d3b8e1a6be62a0163cc56f62b02ca4b0b4ba3efd9bfa0e8e4bfd72284bf7b6a055336bf2291b7ae009652040ed350efef9798b82b6e28248b77dbb1c9c84fcca4b2d0d43ee4393e049783aa16020f27f126f10f3dcd4ae7f6dd2d6929953cad221780fcf1f0b52bb71174453f7ede83d9aa87ce115e8df4ceb488630b92827df011080b1ac980d750bbb024ab59ef43a17a6813653c4f0814f47a3c9844f1733fada0bbf81382cbc296d948c7090b2f204ca5c14aadf76b98fc93b099b1626c7a7530a1d2f3547ade5be574ac82f3c92ddca209afda019cf91780c552aad1c95fd3dbb042835721dd6f3592b6bcca45ee0a6d28e11da04f88072ace761ce3be37550edb731bfdaf5de2f87d336e0372a033a8bfb19fb284f12df011329aa9dfd0928475cc126713540360a3f1f4f99d26e46d9309b8fae4285f2c6a4c876ae7f3b6fe1958f055fb7baa568a4ac82e93afcf0aa3a88d0cf5df36398e1e343b956cae2360d378d409e2f044b96c4bcc07ac4246142efbad53612ed5b574bb26a139278323b43cf102feb587f985614db4bf69e92fed60f17d1aa92248d838901f7d141ced91fa2767c3efca4e10501d4c342b23f544dffe7d4132c65adf153226550a6e30f82d9db97a954694141f212fb6844a5afe8137bddae6304c13b47a29adef79160ea933b01705eb4bf253947a7cc83731e06c382d122552a2c37cc47c82522097b27f43ce52d6cefd5e8ebf5a5b63fa2e8a376a222e7e656eaa38700e2319d90495acee36d69aef5c5efe3b14cdee118abf36e87498a4fa2a71e204c94a1ccb23da5ed94c0962265dbd44b3ca20c4d3aa7b9529209a30e5b52b11dcb8fa9d2c4ba835ab8f31f78bea01571200224b0b594d079f4aee32e210b32671417dd647a923d46d9346a80388267a94d8f77bae6dd48322009fa77c4a2f18934ed1389689271bcb6a562d06967ad883ab8b76db3c49c354bb1b7d925724083814ee9cc5f862eeb98f7331c9544bc4e8659775f623c4f52c5491dc2932bbd6eb2311fc2324b9074ffcf6c7e1b914434f803fc4db0f4629c0b2654d50e7032ce4b6534603e76088a9b756e1b0be7c61b58640c8872f07945ea5a9fd4594e53262081c9dd6109ee6456c55ba8dbf0c3013b1a2dfcfb3b6087e16f54e3353cfc76147d31349c409591c651994118019030f72b5412d045aa3927fd126d2383bcb55930ff832f847952c805914959a6dfbf341d470f4b1673a84f6957b028fb8cc7136e8ffe35f880e5c1ba60010628cc2f09e57acdffb82bc18e7da7b39fe6a3d50d36d9709b840a39b2c73293a53607c6c8fd0a1399c7713d9f091ab2103f2df66015ae675aa2707bd388f22c2fb67ebd23ca1b9f910abd835909c2809d44c3e944e9ee324e6c10cfd429d02ec56e35fd2cbb3cd06f3861149d9dbe56b04595b432e7e1a057bba60caef3ad7e80b13c5463eaf190262250903ab2afa097a6d9ef97ef6c28c408f84080c35d7888ed47226c27e06c59524d196b6534acd34c1b11d89d3ff6a56de37c48f9c5e2d2d360b0ecf0ffa3cd7a0e4743c98372d326eaa4d72f0f45d53abb6154bc32dc57ac1294fd17812cae26ee88b5aca8658f1880a599326d3c787ecd43fad9ed15bb9065c528aff59494f7e0cbaafbf0d38ecf1aa1792a4b75f25b1b5f07a382ebb8ef99fb662fbe0715474285a73e11e1244cc1e1c5d16c656361c36497ae37692c1f1a11567a2bc7f87cd5ccd0a426654f2a5f9339aed13ce78645151abbdb6b4df52244ec72716f7dd75e7298ec6020701a1c7b9aaecc8394970a2c76aff9da2076c57bd8ad3c1009a55b8f4e5491d82e13bfc256571759d4967947b02d5993d4d9874cd9cc436b1ed46909618d378ab6b11234d7183d40f85a6b061ba831ffb0bd4f730844de1eb1951d72236555b898a0723e1745019256ae7b99d4579fbed4c7a9cb8ce1c01c0238aaa0160db22c327414076f94782bdaf095367e9cc724889af4f132d81641788951c0bdee11f13eaf665e73a2483a49bf78e7fe7d0234a8e5ffe33caf7148850f74d1a74f7a35e3f877ac29856d08f4893e07dcc12b50586d58ebaecb7e45ce219a5d16bd0794aa800be1ee2ca6e22e91fef9d486e7177362bb8e16fb67457af981b9d07003a365d4b96ae09f2e6d19458177c67acf49b9404f7313404fee2c3874b7adbf4cd81ac297421dda0d7e0d8619ddd419f19f78921cbf77e11ac9cf57747d75b10756b69bd032e754b715e7fe01f9a6b851f3ccd9faec4d61bac1e2b6000aa7adb7f7e2000854c3cb5f2ab78c45bbbde87f9577c58df35cbdaa8b17815060036cc0d0c3c13ce6ba1c363e37a0a3867779f5cc57273298035f578458f0c207f8ed0729c2433a6b7540a533d16cf37dbf7cca83a3eed8e7202855964f9530b90e6de6c51773a1112cf00116f6b3791b0a4f904f08643614ff1c226dbbfa5b61e8718a4fbd181ef1b159e383b03ea0d677a83ec2aa33e1c5aaa6a8005d7b199b6a146b645f04d6bc670b6a7053525eb48cabda103050729aa02b5e08215f29e3fd56cd3e006736b4854c32e5e845238dfe091c0857150809d8977e5133f24f520568d3e8ddc215a1d5aa4a0a186c1e7d8908a24c4286d84a86f0488f28499ea22f7df8fdca048a51dc245efe028968f1fda5e8292d615cc5e4653db46d6314232ebbf76dfc8296d6af6f57efed5f97e4776046ac2384e5f6ae3d6772d686ac0e527ee161c2b65587f9efe1bbd0"
        )
        val state = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, waitForFundingConfirmed, TestConstants.Bob.nodeParams)
        assertIs<WaitForFundingConfirmed>(state)
        val waitForFundingLocked = Hex.decode(
            "aa277060fdbafd9c1178ed57d83fdd6def06f17f88df1437db3abce9088cfe863eb01e4cf74879a9db9074d3cb00c12e60a038698602514cac81ea70657389efebe3ed213ed0d688d3fd81769388badc559d142b8c45c81c14205a90ab8f023a398c36cded2d416069292f223e1fb445f12a09ccbc1ae1474f77e5ef99914f93b743a12b73ec827b6174fbccddabeb024cb81f93ac523cb158bd36f95a8f1cb17b90be84d895b258e657b7f561b19f974a90ac50be9cdb7df6ed018db8029fb544daa5a64cb4f75e650f22bb2760f48f4bb368040203c1d3e1b1c83a697e3dcc570cb6723a59fa42691f08ad3d2e6cd75fb6040e7d25294e4f1d4a1e2c4c2dee7874c145669ad825b01972e93f87ce7eba3771879719289c31925d74da0427b5610d4df93a9e5a31c0b774c61fa292df31e2322a49e690f2add0458997adc18885c67ad5c82a4ff96ce01b64071fbe834178d3df9da86e3a10a128e4b95a2c9610d0a3ff80958ce5b7176b99e2b9b8ff1c88ed71a2d3a4d8608e6c981b95e679a219cf7d33ae7dfd5b43268aa6fef8e01e3ff9f359befdebf77914536f5e300ccae0d2e2d4371819babcffae0bf90fc632733224ad83e29f6b8bcf8532f758eea5701dd3ef379d5faafb7ad0e485d349f89cd2b53a4f67834924ad8d5a8baa19f70aaf72c554a9f8c63514b245a07159ec84637b259a22a5b1b0b66702bbe7e4dfaa989b7fe894a1489021edf9a4de781f552a655e76b160a8414bed920985330a554299d5d50c3502a4c4e13e4ccf31dfc6018f2aa4790141e4585a3c5bd0983be25db85c1b0b33098f660414c8afa29501f592058fd26eb54493ab4e6d4a09f912def9f1bfa8657e448200127fcd94b546097445b6f98d3149bb20104d175ce3399b20b3731c6a6694895668866fa516eedfe95351ea0aa09e89c25e9b3bc7b969ee37e75eddf1d07b71de0d9d6b12ef529dd2f65513d58b45edc3e9963337c24f44c48a90afef7b5718baf3b4dac714fa7783b2ec8a37eba7a158dea7830ecbafbb52871106ec76adf4c4c7ca997bc6b739b981e11f95203cd2468097df9b61fe53526427a4f82dc40e9826a33a765661ea12b859163f417121c39ac18c3118d0e5329fecc5b3967dfdeeb62c026cbed2a6635985a8ad80d5c3d95aea8fd0a987a3cd7b432820d0abe6cb9d00c643a1646fc0bda745d4f4756c58f19697dcb0e7071e445cf2d8377bdf091ad9a16ea7a4e7fe9cde6b9e0665be880fd608307a744006a4082c746a89a76d7b1f140ac92b037ea1130e1308cbe7a8ac349c9bdc44e566e8c16b3d6ba3c0d27415b038fdff75bfd288038b307afb5204847e62343906929f49f8ce92ff4947e6627710f9e1e828fcecc22b448a59821bb235ff85699a1db8489988d5c0b72b4c60016f7c0dca550de679ae27cee2273e051691c31058f211b479fb909a71cddc9d3f0cd0bfcf42c637aae1e93a8a3c14adafada2ebe64ef9a931b17f404b9e31dfb1bec00d1b9871d5bd1e6b9a8bce979ad32d20725eefe387d5d0ec697d177d8d73817097af1805c7471c5dd2161b3620b415b6102564488d81e22ebd72df6d621fc6213490d205e4cc1cb79eb26ec45beca6d095c881dfcf64d5452d8b303f94c0d6dce3de0ff5a1391d186b6bd6fbe71667e4316e1a6988f3ee1481dc92948064839388f31966e497123ad9ced8e506347df4c6503a7507c282273225497b1b86a2bb4ba0d437af0f5209d9b7ea5d458dba6a191b2e3be8fc80624a7c3e856ee1f42403641e4b8e13e9a0badb9a738b9ec290d31c54945f18acbdd1097ad7187e2802c965c0987f03c589df9c3b10efc585a58fe58fdc2dcedcea46570e3092c5dfd795597a1f55a991e97f29e7ff5ed5738361c03f25cbe315a0ebe1e217377a9852a2dcb7f5f3d0e6edb237d21f37a966b166be55a26ac03f378af76e9e7c702eca129c86bbcc9adc9c85e8231154477295e7cee11723ce0ac15ea6840807d72ba2f0a702227538f40cdb3812c0a5ecb9fa17d959ce397986ddb87de30c4203a2f47eb5d0238867ba104771f92058b37b7602c907da84fcca356bf20ad47edf74694300bad42c4e5f86ee82f91f6ee9c5b9862533e257ce9d6122ef6c852e38debe1ccc9dfd3b1f7fe48cb279a3c1b8c4de00951153bb3eb3cf6fe27fad92780671f4c21243b9713074b9ee5d920357c3826ecc9b98c1526cef37224f4f2ab6436a972b9276e39fe5942c382e816d2b30242c89995401034bebed00501de4389237b458b6ccedcc13c281eed8bfcb29febedcf71fc1e24d3348b606129201fcaafe830447012d58a588c8908bd5d30f5b9674d09777817f968849aa8bd79c61f0ae80bac81fe926987cf16772bbe28080482459f56765aeae42672800bcf1035f16676472a0753e35d94741681cf88f875607e81e0170940e979ddef503c6bd54c52fd2b542997d5547fb43fb15f9c332232d59a0081fda409dbc69c8602f87105770f581ac0d38dcbf66620c2e9316ed2d84fe285c72e883151293c6fedaa5b33d079da96eb0e542d7acb25d0110c58680d0208c1cdb2b04dd736e229d17d3cae817ccd7394cb212f8e3f74b04cd8253bd1d3cdcc3203656b0a6ffa0ce0dc4166f0a1964b7fb75a8a1ed172ef43f2ff421ebc814b000ff74520d92c190849e2b34d848fe739bd71945ed614fb095e92ebef0c04585d5c787e695bcdb9681977fe2a09678a9f35b117e4b10166879c51e1fa67b23b6a622c3cf1d7ece3ff68a79883394bef08cacc9f7aff575dd32fcd0f1480278add62142321933fc530175975c8f3e97a46937212fd2ac7940f194d1064656691072bd270aa6dc422797feb677084e8f0ee8123dd3ae81df9ba6b27d8e5477b449a30dd01293bd786eb39a19ccde4769860f1a9ec9ccd7deb06f656300ae9c18ab6fafc8a77642789e32dcd4fee844cb3895e2d7794f8f437830a1702b49135e03e7a060a4afc04961eaf3d811f41f3811065ac29cb6f1305fdde69907d74e8ecc0395817b4f2ddae67dd5aa98552da33bebf919535e3db5711ed699f1d0087a95cf2a1c8b4bff3115de28d37e347232cf1d31ba43a54758a0c38538a1a63adbca5c8ad5683755c82a749ec93c4663e257aaafc1c3c55fd337d0ff71815fcd28822dcc62efff7dfdc0c4144213e2522f679c4752cc380df49ea00c2def1e5fd7fcea267b81e8c8aea97dd2216e2b1bb04cfa85dbbdc9bc6be24b8fc2019ccdfe877fa967f086dabeaedb39eca85a31a21d193f5d212ef51a38ccab9756950eb186e574cc9fcb4e06d85dec15fd93cd6bdc3a5c9d404fdd088a20fe811239669362dc25b811b05df5c2efcf2b9026c77a59f1960dc359bbe1350a45340da7e6eab110afa96b3aef6b51cffba027b0e617daf32ca78928d5d70923a3e3f0ae5005057f1f7062484971f4492e998c1f840a924b7615801e9cc50e374a76fdec27027bc823753d99358d43ac37f534859b6e8d10eb496e23db7cb557205b98b8681588290dad6b650281196d252db4bf154e01e6f0de08ed0c578ae97f72f58cb571868e274def80f2ccd6a60b9c97d2ba236bda532ce419846f0e3893ceb2ad36faae617d8af37e2089fb4d183337f77164782e0c3666e5f5e846e581ceb4e0324b47fdc9fa6f9a654f0d933886946a076c5762ca2c255e221a16f65b4d0362e5f689126866b2fce7ed2850d69e69085c4fca5143aa54529659d4a5db1f62a6438d2705ad1a2148592a4287d049014ef292e882c342c19050b048857a2c07c2019eab95dda7036e36d8fec3d31608e2a4177b9e43631cd8065eed7f1c486f0d76b133f5578827ecc779452c5ea6c7f4482b2814a7611bcaf2a7b049d7b6ce0537a03c8cd31341b5829db0edb5e96c84675ae2736c1dd7664d081594e8950c261c7d4a265cb75a137d1d77a62996cbbcefc74b73e2e04168cfdf9ee25e8ce747921187807a4b5bad795ea9cb4a68c59a02e5c6178cf11c919b8d27843e4aab69ee8ddc17e170b7dbf216c850e237fa1451113e0727358be3c39265e1a24fcc091c2b5d5ec6d8f5550b393a8c4f9defcbe7b30c6045d7e95f665c3373e3184a0f87e67cafe2369675fdde7032eee447110023d4c8bbe8d1bbb192bc60e01673529f52a917833b62413b6bd5488fb781790ce6f6184f4d80c82e80b04f8c1be4adcc2062a11a7eba518923576e11719b463b25d01eb79151a0b95448d20e899748fcc296364df86e46bceaa39caf1ec4f39562a812dbd50e9d3efad3c64188e80527dd483622d55fd76d3de7c6f7e0d179fee18accccdac62c047e46ce8008970ed43cccc5d6de9e184f80f6a210bc36012b617da563f349a8dcfa03b760d12037be29b85cdafed4a68251bcd1d16e630b69b97f3d78b0c938de1f313191b9abec8172cc6f327e0e00bb387220aa57fd9ab8b874263c74f80ea675d18a75fb20b4ba747057283b713b80cfb1c19805ace749171b9dca652959f9084e932fad28a1db471d41ea2150bd2f1fb5c4f1640ff58a65307594a21ca394f8f505add728dbf91ff4163e0731e1be3ee2973d242d856935bca8c6a9d949f84fab0f0ede6946bb1d289317744513cb7d5579b1d19d0cac1a25f0c4f8bb5f8002b65cbb73633169f3cb7fd27359b1ea200b54c63ee0233696fc4e6a862b3454766214c1a24cfb40ddc1e73441d24a87415973e25fc05f31145975a92f86b085ba5c2631b9eb720c98c2d080fbf8934abf96ebc8fb7306df30a443206301d9490cc69053c7c7aa7f6c852392803c744ac5d1dfb0288466f9527e60cda36142c6e1265761b59b4be082f5d55196966164a58d609a812686b20db8e08f3bb92873df8b02dfaf17d79a86c3cd5e31d1fc898e0f6de1a2eb9b3b22fd2f816380da939ab93300521e94a85e0e36cd05b8617e343b64ddea3d921c782d4e5dd58eebecae46b4494c92d5db4d6bae64719278f25ed9b01d8a1ae92e081e4193d069fe9fc2b9967a4117a2afe276cb44d13943dc71f01b8e560f2432638c149226864e70cb567bee79c4d7a4aa4e55b66a1c892196e2876513754e06144c81176e054c905085a49daa963318513eeb734cda2b96dec9ec10d9ba6788ddafb3f7e5dc000d773bdd579f13bbb8b8aaeecebb6c3a61e68780ed763de0d8cd5cedce6ebac3118c542e93344227c5741baa07ff04583d4a015a93a5f41a72e7ed3f8280b44630dc5e9dc27bb4cc0a0902dad38922a87ba8cdaa152cf1e9391f0fe2764b4dddd6beeabb"
        )
        val state1 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, waitForFundingLocked, TestConstants.Bob.nodeParams)
        assertIs<WaitForFundingLocked>(state1)
        val normal = Hex.decode(
            "c207f3309e3ec64ccd7d576521d7d0e65dc36292be30d7b84e557bfccdd8102480cbb97b1f9bfbe267ac1b09b8b6829d9153cc5f132bb951f8bfc3cc417faa9ecd6ad3491f65816571dd304d1d5851685ec689724cd8b57f6cdc8451641b85304cdddcdd080095ec5cebe0e1a2c64d8eddc84eed08af8d423e92229a9fcb00860a0c691ff526f7909ab1b8ce351efd7a206322b7177ef9fe064215d0f8d13fd2ce474893c6f8547ed45cc69f03943f328a81169b18fdbdf82f5fd7b1c1af5c1227ea231828fb6ed0467af0acbd8dcc57f0880aae72597f920330d5571b1e7f7641f7f64a7f534dd8c6099e5a5361ba35fdf8f472407dce5867f9ee75ad89ccead717ced8525a1db14c529612fcabceab951bb5a6e38421fe1bb7c092358105ed2ecf7293ad0f0cde3873dad70a6668e44a6563e059b3fc08e07e3265c0bc708ca75ba7a9c238a14a8eb125581e998fa8c489b8dfd720dacd5cc8de832fc0065b9aafa2761672a4ecbb69f24df95e5fe892b01623ce0093f816577a832c9482308bc9668ebf91a89739efc3c965f34dce28674ea45fd841e73c3ca1eee01b1cd0a7e30a0a65c8517a8192e0b582aaaf7a3c0fae8776b38aad7e38ce4e680c44563ce3c635ceaf3b0295e4ff113208da349df01ee5bffb6e357c11b09fc7471ea204f1efbb214f1640029abe7aaf7c97215728ad66dc1d6f7b339f935a6a2e1f9f1e5070acedcbc7a3f8a7289d6265664b21c013be3aada176cfec2dc51c5b7fc7c9e008a837d3ad48c7f4db82d29462646484b1173017cdb81b2bd274ec565b67276f53eca3a0980af205759c39e8605f1a171e34b38833f84f3c0d29d6467c6df1f1dfb8871aa91277153220c82bef0a70d10fe58a1b94ec011d5404f4423b25e471d0df9194dc6df5758b2ee41411ebc9e4b911f6803cf32356abc8181644608ca55233785ac60966b80e567533f849f76876a99bfbfa40f62b6169f6518badc1aab7b531b223f9282a723e6426ed310ea8e91c0a342dca9a160955577ce97e0447954000ef048cdcb0105b1a111409dd8a818c36cf2fd4cd8d32065ef8b6b8bc4270677c40bbac05a4becbdb1c1a5f88a845f2cdf1e39f71d5e668cbf44238dd6bd917112c1e963421c89ae84ae780acdeefa77131dfa4586811ed6f0cf88cc78974dca3d8b2cbc0f7d3d2266c5756b1faaa16587367d0e0a710db90b5318537601ba713e5d06ce5a631ae5e31b6744fb5ec39d7cdf65c5c2f265895b37f079acd6ed4ff0a9ea780899bf44bab32215c2440ba1e0c30089a5fc49abd3c8c3c847190be76d7f01a1d6b1e611823c58ea168926edf8511201183db5c7038b0d1d9c6aa3fe6eaf7c94f08e2119612e4e10cc92493c54d35e794c119619baef4e5492995f5e3c8f5ca002382def7f4ffb5a27ff8930969cb528fcd1713a9166ccbc6e105568c495148f5e35a64fa81d394d73ff08f7ea3ee21be2f828ec0151d6a6a9dcc34a9664677260635c675ff182974e072c67967cd08a019aa4d595467b77198adc9f43e1010a5d5382c99731b05a98e4fe600e57be72d29693196acd5c92641160cdffb4cc4bec84c1e57c9bcb3581ab98f1c3c2b2f30d79813c46b29aac84a78d66b37f2ccb63db5e650b87218401be534b54295f6772fd6ae74541326fb3c27a1d386b9dd9775b24996f7730387ab409ae65acc14d7bac0c236290e9531a833b0519f96a0f1149a4468e6020978f5a70531c73d8b15f043147302886a20334a57c181c34e386ed16fb69a27aaa791aadb3ffbe6b6cd0a86c33ace842fbb1009754b3f5ec33242ad0624679717eeef8422e6f520d320f0fa7e3f5cdf0414aa0f9670b0643bb38cec3c7050fad6bcb394e30e7b23d6e49a9a9978c9703c8a14f9bc8ed592c07e73b64992fe2b255ba5bd07581dc819b2b271aed6e15c90f003405b51ca45df390ddfb2824284a8f245f450f773af6455c9effda695a5281389da73f10d101cca7e484e6a0dd206c2206c6952acad6e593513f5cc085e546792285d26b6d21aaa8a516edf6d2e851e40a0815652e2ebf293f82cc796c15629fc53c706b46e8f591b10f360294e5f10430fa575dd4aab6893df157a75cf2cf05fffa20dd264701ecfbc34affe72e9594e55cbebf19f03c0ad3873b8c284bdfeb95f1c8f97e2a0df976a38a599c8c56110b215f5e3c8bf1aa854e06b0b1ac34bdd9d7c0cdd6f27b79e4b09613fdf20b50d4a4ff9de27bdcb559d184220a0f0415dafec69f7ff96df6d358433f7b6f8fe5748d51a6ecec3f90d2a316ec38f4a3a0abe39464b7a321e5395cee63eeecbaf2d88432b7df923dc88ff36a41bf374b49d791d2d659b94ed236e899886900aee1c93413705c03dc631909411839d6b1b9ccdfe9bfccb95bf67d421234ac702c247a340b103c5b16d7e4b13f17c25bfa747cade204743c7f3736016247f1d412a3f5d7efe4a0e2004f19334bf7b9b0489481cdb593a2cb482e0027022a795abb21afb1656f5a09083f40f2786d7e1ba53b3295b05f8b96790960fc348de406e604e5c0665aad131cd4e930bf2ed0fef354fd4971d62a9f3ac795c9d36c01e2e0bcb5db96bc946710909443e0630e39d9d268bb8d6d75325162cf0b3929de466194c3b054440ac54e1c2ab28b0b4711c418547ed5500e6981117f412316083e892a841d8a01550bac490d149ccefbcd4cad9ae5aa9205edb317f618b06acc59501ead750618994c793bea0423ae8e3513316282d3722baa1041509b0368c3230bb7e10ad9f19594374664ffa321a3439843a12d69fc84f206bb0711c67d5fcb7790f43b78917226c1db29423e05074a9ef178a720c649010475ec17b121864f0f615e9757d51c69ca8ff9a48e8fc54916182642c456d2c12fa4d94e1f4a6e916b32e342f9b3a7179225c517701bd917c6de4cdc3b8c7bda7a977bc34162f11c00ae0895b3331cf542fe3c689a9a235accfb4a28f18d822506c6c6352697eec7d7732b5818a3783b59427f75653469018736c3dd03eefdd565b83a878013bae85b5ebc40ef080d39935081b3ebbc629097cf1a141c9c0f64b08a3f196ae8ec4b6fc73757e17ca47f40d10a309f936e02598cc305facc421ad7545cb2f4341cacd42ffc28e5cb51e3b03e6f2f530339caea268fa415845477fff3c84166d7fb26a975fafe88180fe723527beaa633f2fb268f85f87fbd912d79fe539639ff6d3702f1fa08f6e03975a357b33a999a5c6186162c108efb32f16007c10664474d10afa814a9ceb593b5a2a6b1c37fc499584c984cc7f78cd80c1ee7959280784bcb85d902d5b96896ebeb6b14851be00c347cf863791f7454604e8a58c9509a56b82721ddd80144bedcf3053e091caa0b574d8414a8946ab326624a8914a5c7b36e002780e616b6066417d0c9e6d0de5825d760253ac938ab3aa2dfb73cf41d942cdc7c808bd400bfb0716f15bf8e8953850548b4b8d1c2cf4621d324e7207cbefb3f192062e79216fc8d71820e083bcc9285c51f94141b78fbc1aadced9c61f7fb9b7789fd17dd664d28e4b73b4d295d5dffd34636de62e7d449e046a66539da5a7ce71d38d757cd185e873f375bf5c34baaf78cfada8f8855040f82730fdc567c08767706515f4720eab0e5659ce49fb85ca40b0cd111e00ee27c6ea2592d0da518fb28010ce9fb36e3c1f02e4eab361aa9955193b00c846a891553e48559e03d93aae894bcb15db586b36f2914a3fc841b32e80e33d873254b6a18107f4385bf359a1ed6a649e2b4ef7b11af60af4fd1626c11324032ce71fe707b3e6b0ea320e6540f294acc36c0e77366f6f1f16f4683f9c73da6ae77d6dc36a34ed5c23e5d5e59a82b0cd2099510cfad3fd6be627a26d11f8d3a88e1f49f74fef089eed30d07123343229219f55c5bb15a5651fb95304282eb0757506de37cc95cad16449723a9bb7d9a8a087bdcfc15665c7b2787ab1478255ddc530cf327c22f2ef6e404c116045eaeb8be9a137e754c951a1fadb3829283107eed807e1ce7eea848600f4e35cb37ed21c11b3c6977b05d6a9575d17a5baeace3b036eb87f2fab175b6e3eb1ae6b22acb454162d257737e59a38e346abafba9ce1530f5a4a900fc6f7048f0aace10030c638fc205a1309e792dc37639f69f5d569a1d1b2c5bdd4d45112bdce3041b9a117a82585522854857dfc686bd3f6f4149dc0294e7ef93c21e9f006c1b9994388634d338c8aa4b10c7e2017a131bcf4a9f1f5a44e09b136b5df5f3b80cc2b4101859776e6f71d9e5a57e88d623d042fda6e8512c582479e12116993a6357908eee94e26e103ff2efb102b5a52ceddc323136ec21b2d87b743fc4ab8339cdcdbc717fe77641291f9934cb86ebf227f1214ad5072"
        )
        val state2 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, normal, TestConstants.Bob.nodeParams)
        assertIs<Normal>(state2)
        val normalWithHtlcs = Hex.decode(
            "9300cf64e81d29328c082f3b98a58b3e156ff01126416bd5a64d4722e4b67db83b692546b8f2d1801e2b2c3ccdb48e91029b424bafefbc7a97dd069cf8a287ab2ecd1a18a5dccb8fc1012fde3d3d65eebae83292d646405b4e696533fcaeab0f689a1a15de7aeab322f0c0e87a503bfae2165a514e9bb956217f12504e16297e1850038dbd4898c14e3da34bb6cbe01ab5aa73759234498ccfba5bc08438d5f8788c69bc1526731fb63949a020d3a8bdd50010369e4ff6b2177ee8793e35474b94ec647502fe5b3ca4e452e27d425a413e06d0ed63a908ec4e992601b5af34778d65d84162cb2d26f8793f47154e514eb6c5ba9e8b97712cf254185161ddba8d360d87ca469a32e6f20d5d91fb75229616156dfdbd955b92a28b288884f99ce0685310e8341b714173f0ec83d87de9502bf75d98ab298f400386c2b1804826794cd68859b2cde5fefb020e8d8117b2789b6f1d95f849c2dcd7dcf097207ae25ec65625bbe5a7465983a5a2197341c5e2542cf29576c9421c163bb69cd8f0f1be6246f96e62cbcb2398870469872ba1c1b10f2533c8321453ed2dee3b62dedccac47cf631568091add2f6408b138662a55ba9140b82d23759990884730ab6b9742c56b8b272944ab4365b8a9fdd67a6e6c3b86fe80c67a4b5e253b302695fb6163cdb1a4b118f16869ce40087cc3590faa07cd6d3c534fd5c91ae89ba1ed627ba0cba45c3a3ca9b49bb6d0fe7d57019a2504c601aacb5bb7deaf4149a6dbf1153da00f174d42f247c6e62b4d448f028900fd6f11fd308e402f5f71593c50320edab2e8e4e3569f6be00947bedb229f2e6cc0e34ffff19a3248f3e9d71b0a3f78d81d7bc6e1ce97cb7f127b65c7d08b5e7b15e9d44f28f590ad9e29e24a2d973e6fc79f2abd86d6915e7d37393c5e280e8fe1854639105bcbeef5c9ece791caa1423e6c66cc351ed4ae5f47d326e537910d786bf738529ab2b9a658b6f3d490103f4082e6021aed15b29f65cefefe0daf7e4f00a321d8d2bda5e3ff142e059b027da3f9c9bfaac311ea0c577a577a9d257adef445c966e301145dd57794aaedcdb1081c89ee86b65de8a515afc6b2514e64575919692ae764440d3e723fe1aeff40206dbd85d46cfe2aae6a9229f08f04bca768b7cdfa5d118cdf6de5c66d44d5d98e73cf593e029ded9b87ad381ab0ce0eab54ad98cf52160b75488943c9ff4e73778cbd60435dfcb4489c8c9081f9ebd650367a8f30eafa036a2357fce1f903eef0172f7ae42d7277e16ed1c095513955316167cd69f3f49dbeb022dffd8f5df8b44d9f78cbc47276a7de62d550854b2832a99b4a42a8ab709dadbe8a5c595105eb90895ae8e3daee024a28f12b4f98ee62f41687b486bd99211d478fe4780a301f79205c87e6ae0c7569721f517ca0fa0eab19727ed01a6ae12f1ae940ba86c4da24cb07aca3f3abe6d9146735b5fb45aaae34f9720ccf3d623635e9abd3408aa40ebdc3305df8624b947811a98e7ee11a3cc2294fd0e9506ecfdc936309cfb0c08b673aaaf139f2458d42b8d8895b72c697cd81462eb246122872b89a241993306fac6953da58965b290b65c47ba9a76c16aa80fbe05c49c410908a899cb0382977926f51e6e95b062e6edea331d8a946ce4ece90564c687e0cce1b64baaef7b8f874493a9437a50a0f333582472634ccd05fa577c6a0f4ad27589ce7ed5ea9dfad20381c2211a1da8b6da908e38a26191d216e9d060b7a288f4f695135678fa48a29b05672fc2d20eb211a4c7f71d7c07299c9262d21cde189390871a7d8cbbd0c170680c841a3640cd5a9c3ec1f63ee0bbb63a217aa980350f8ab052d5b4d9e6713ba353bded4c9f845150ef95165cc85973629e93fbe51b6b206996433e746fd5661dbd2b2a9cded9ce8ebd6703d2274c861a6123e130758832293f361962344ac2e892ec90a759b1ab15da2c768441b10fa68c10695dface2235ac3d498044f8d138d8b1a995195d71af31b4fadbf7899b2fb5f69f60df52139a76b27b61140d4eca6486a751c1b58c928a2126b91811b2818f5153c92d37aa998f2587d794e19adf4acb401b6e167de0e04c5798e566f70aeb92e1e5245fd534639188f345168d0be0606bab59a26bdb0565fcf5b5e95a4f2e08e0279b06888673e3cd851b86cc4eeb20e86e4d349ac6dfdfdffd9f3b045ef4699985f2c3d331133949c084f5e3cc7ada6c23ecd33ca20a6792833974997f5a8276a9240bf10285b8526b15aaa2e42345d7c10c5a947121b95356e6355840dca6d0373b41eae0c50e51c0436970449964a855f9d224173f961280e27db6a2d15ce63aee3d937a502f068ba31df25d45c6b100fb4d05a5d6b0a169b6abdbaa932d0134783af8cbf18180fde2f71ca5ecd4a02c752322eb564b65293c88283c706f01eb4660fe6bb7434b5d1ca1a153ccf03a57b9ee3e9bf4176af312723a5da58e5a265bad34c444c1d9eff74ec262977043e31d4aec08134dd788627903dbe08121089777be236ec4944310796b996abcb698f3fe271289482a0f1bb4c3a4684c6611f57d0d8fe86a1d362097184fffe7c5115f1b9a6762a3604bcef0ed98a8d7d93d5d9e2eefe9130c5eefda67f91208d26af61757950341c89bd612111c1fbf00bea19a5951a61023864ab7737c9b54062e0e03afb2d21333151bfdb9b241e4fff7f01465f5320e928a91313b4aebad1d8c062730eaa3bb921491fde2e3ca14b9365c42a96d679100d074d67fcae0cbef56af06dfa4525f6778cb3f182bbd355475fd505931d6e793a08825d93d9431bf3a2f4cc93aac5d12cef343071c92ba6cffcb22b682ecc69e0c227037a0d731e787f9d86db843cd8d410765411264c7098cff84751a5702d4ba181a86a5dc03b2d2866c48edee6ce2e87d8c2716f2f67a1418d12f50903f2a183f5f85eaef6da52bdecf3952ef82cf57d3e70158beaa0c2ca9a3932354f34cc8a1b85de7028cf05127e3ccde73b716875b2670f18d07a491a786732f3638b9a5225a7056b1944ab5b0d57a98e68b25a9bd76e13d0483f8bfe85d29740b74c3d7ee81716fc92798223df1333d728343ec572f405bf8b5a9dbcc823712114609c70ac2b22fba0ccd0f2eb86ab1d0a3f1ff6fd2c9678c09ce508fc481e8f70f5e9dee0482ba942397bccea74be1298c9ce855d9bfa0b2262e94a3256414e0c3b4f4de4d313d557c5b90312da459570aeac680d9a2f66a584bc190318654272b3526bc2d6d8957e70812855ab79509ea9d9651822490e58dc955946a256d01bf570f200de1936d7052e65b2389c4e2f1248202a0ef9a4fb3c5d208944b80240e42af270daf3a0f22b6d7d30aadc526f3b99206d4b7221625c6d4cc7e5631d2632dae992ec228b331c0e5c4c32c0ceb1f1ad26c34193ca1d3cce34fdbf32ce475b7eeca64e1d26a3631868fcfdded27cd4e6d2cec404d2a27236308664702e512cb7a7b6693bf9d43718b509b063a33171cc6e9a30fb341e39e4190e5f84f9fbf429ee938348dc15dd0e876a8dab35a938aade07ecc91ad0e28dfa06866e6e3f4202fcbc497232661251503d6cdc318ffc45f968cbb7e5e39035a2334b4a09cb7fb5b895fd44a4626c2f9cb7bee2154e9d4b97dd839b5a1eef2f0bb516df840331ac3b7b2d01eb7c0558e81fd48203f0896be1d776e1bf43631825082d3fd663258ad9b252022ddace0da71aef2a88e7ab9d3b87ba842f27a9c151838524180fde5c823a6a2a6234c90a9e0b5f9becb7f778d25ca9e444ea7af121c2b64530ec3e04650448e455a6c4df4d5d355099e3b0110aae59e422836e35a1b49ce206e6b0f4cce52303b84ebb8eeda742a8abd077bdc918042ba36cd5e78b30799029fc218af89a76e5fe92ac4afc7ca4f3dd52324f5bf5e21d6976a14c91ec9ae47a1c32760a5dcb7551c3bac653fdabf9a74c65ac6c2379603ca79e599a23ac88f1621965a343b310fa72e73f742a736e08ca4ca31a45bc4da026e3039a5e3ad1d43d87ba4a61da9ad373902dd823283d0224dd24065d240c14790987e247b27acc6ad4f601e0e7c4ed42325cf46052ea852d05fcef605335569a7994d3744d69e9e83402172cd040d457d55a9e72f95333bd8be0226b5e8c4dbcba64359ef2499e34ca2778acb3abec1d2071373f667f6d061c2b11a5c7958385309e9d3e8ecd586e3b78135a0ff3c15f69ea05b5853bede01211c1a428bcccc9ca7ec1768a02ee356c768323f21657a94a477ec7e4fae97b3cf8be54b28f8fc00dfe8bb8ea679e826d63f105c554723502d5c8ff8b9e5dbd885253d0fcd27a83dca721571ebb2aa63010fec634731728421f982c71adf8fa5df9286ae97fa8fa927a7fbd1f9efcbb77e37c8f4761e02db0370844ed521f95ab859987f8d4fc1d762d0914449d62ed0ae5f44f856004f0718c0b4171b6d09d74a76f97f26aa233f78c99949979fc0c4ad7ead223af590ab6cfb46cb15e46303b4139de7837f709bae68e8180d1e1ac151f575e56ac9ce619cebbfaf76d0c83708e41f1038b0134571cfb7673d4b6b2f6cdc053891f64b33ef9d604caacfeca17e6eb73ea96ea66f32cd85972db179401504b8df11d58281c5cf0ceb6e96644ce608ce4f5eba41d74431847d7f2da1f8a17c805788e726b65357d2db94363ec90f245029c423043deb36194e23679cc1da75714e5196aae121c48c7c176529399faeb6bff617297fee33c287d08f530a489a4eb97cebd47eb5448df69bc423f805e56b759fa4a27d8f161d457fe5e3adc662da391352fb3f567686d84b0d366e3ea506bead1cee37e2a4abba61e52243d975e3e5d9d685a5a08134614cd34a0d0930857e8146c240b4ef81083a0be988f66f81056272742e9326552fddf22e625a2497449e0fd89cfc3bcfb34168d8ff30cb03d732f0f0e29c7af0c5c35c87abffd5e8d4375574a7b9c70169ffae3a65ab40e4726aa3ba2626f3bb946bb051dd25757b5266c5ba92244023b64ccefaac806d59343efad15b3acdbb0db21e7fd1f9d0dd245529624256ef79f032982fd3f1841ecda72dced45768a4b95a28f1c9165c009336a32557c42109804694c309fcf1efa48850bbc62a098c1a1720ef5b69862d53c70fe4ba2e86aedbc1a291673c8c7375106fbd690dc44cc945d3346d0e1fa7e97cce996644e112d634bf0435310347d58cbe178f694e4c252ac16a623fb1f87060f17ffc2d0392e10ef157242a7eb082ad51dfcba72ffbad367e9b65da904d7d8dd2b2bd01cc71706842b8e2ab47d9fd592251ff986c87a5e92c1a666689e47cc756e9af10bf51eaf2a6bb1f3414000429320fbce800405b3a552d0fcbbd88ee280a3441115eb890a9b922bf004527856b32a735f5a3596a1f31cb127c00d3961e9ef0de7ea81b30aa1ce0d80b1475a24e4edb9cc6c2faf3836ff8e7f9e297e293822156c1866ee49fa76d33a984d93c642f7990b05aa46a651b6138a71f04f3761c97ee4b09cf8b34d26cb76a88397400eef52cdc12a5e2d57565d858db2124b81f556ddf83cecb3e053698b524bd391fcea0bc1cb5f97cd8d4d5a4100df9c2a9d2890d854cc7deee1523cfd43b2b34332137fa2ae8b57cc582a61587c3aa5c361726356db8922df56ec6333ddcd14476869edf76e23f327f55703762539ccaf99a72301675902bc0b23b46939b08054909455225b316a089ab25fec7c47d218c8e1d97fa009d71078254ee84ff688596d3d9ca44e7d153a1e77860047887b9c650f94cfef73907907b30460c175feb57dc872c1703596b9cae41fd24bff1c981ba5b0cf6d4ccd16e291764fdc38111cf8c77d1957cf6d90e97327644c798ad6da48ce93923293c99da477cc8f3249ebbdaba6640149a85961e7cd47ae77fe5a39338ace479f48f11e5b0affc32fb2870d76d41c99909111ad04bbda0127a12aeb7e6c319b95fe8cf0d7d21651f0c7b2191abd87a6ebb3324cbfc20c9771a27435167c53487657b0490d21bbdfb1eff1ba22cfdae62d4e4ac8ee1ca704fc1b3d61999601314b50eee4ea9f476b248bb7598862339d6b9dc328f79ea9c0f17ac5c885dc6fa529fcc61147ab2a04c9bfe9314baf4c63553a3f1f2bd125194c22c33bb91b382bb71e2e85a554a7c652c0aff788958b4a757507c3c07d30e8313ed5329dbf750673563bcaa88bd0e477bf9ce9d455ed687b9a1897cf325b90eddc733dfac1e28e0157ff6a0c323373e27e897417daf037aa14c00e51075091f566d5daf51b17080a8ebf0b7a5a15ecad308c4e97783fd6f59fe6f249553f223c208e55f2143bfdc2435347b36be1df9a9686608e373d26a07a0ddebcd49d8bca97a5daa377635304796174904f7154b25bbaf55663d58e03d965f7c9385132c1782fe5e6bd9b15eb2f09f9b130842577c5087fec5fae4b1f9061ce5d73210fc9c2b509bb0e309bedded725c247e7f25681ba2f487862b2e9b599f26e7d4d2e960451a8e023e46590368f4ee9b0fe9c7cb8929f483dbb15ea074487ff85241d2916b6c19e524c000b6585b05d588eca277489fdd0a24f3f95aed52d40d49913cada7f3297a35be8a5ff8294450a5e14b6a8ff82d40a473b719f118df5663a8eb53398e673a1bb7b3e061d68902b8442a495983023719f243279d9bdb3742a4fb66079840f73cfff42f1cacdfc3a80dc9f0d85d79acc338105293b7b69f942cff96b9633ef42586c61793d57379df777c39431e5f3ffee9b9621eaa2e54e0d4c496b3ade33482576b38e1b46f43ac41232b03ece0368d4e13807e4f130db7d4ab41d43dfda1fef57d3849f20595430cad32ceb875c3093e1a0b32a1a2b0699ac4201f8dab12309bfafdb4db01cf7542f959331a4da2cfba941c0c0d3fcccf774d0bf517bb3b94962c4b0342d3e0483b538b30bb5aa3aebb63fa11be3ea5e660e6aa38b44812e6801411b842fa6d3cc11abb47f5c95d1662e71d07dc6af6a89bdda86da188fc10dee7350efad5bbbdc97b035b955691b10a69db0d3ecf91ed844ca2e424c134487adda3fbf528616baec224a7d068fb02b1f9c93c0d914bb3cf3c52d2393464fe7d9f2ed5bdf2d582bfa7ad709db053ee3699d6b78c05b02d77e14353c642143aaea1a6ebc113cb72b300910496402ee87fe8565c80b9d82aabf5b4707527e40ec9775412060c04d7462c11c60fd03be80a999ec89d3c2d6aa3cdc410cf981e3cc48ade471bd28da5b8532c4b780c02b244019785c9580a87dd0b8d1c443e34d0dd454ab82267542cdb37421ea272565b9711e4ceef6aab8c8e5f75c4a5f0aa4c9072a66e34367cbc28ea29629b936584e5f6a805e42fc7437040302aaf98ee232413752dd6612995685e92b6b4d909cfb8f84155cd52d31d60c471a86b910c765426cdeffc8feaae147482dc831d3d8b75d98595b22268ddcaa5a3b6be75ab435ffab2ee866d622e9fcb0518eb5b76b95c9b30ff3f4fd7682a5a2ff4137652748f66825f030c8afe5a552cc58d08194a9eebf047cad68ab5a3d5d3a73af0a578ad6f3e6fa2b63c5e67543db0106691747b8c60a970efdaf3175fc13142dcfc3806380482bbc2600aefe1c47eaca8a4f99020f1682e56b204270d1b94b9dfce0eea858be60853835a6c4b19124bffaab9f1a22e1f8c16041ae612902b7be92750426d258a9f478a2cc4037783ea6128ec46f99d76431e3fd6c4957638c0628d4d455f66d8517696951b01a6a27b3c92fe01809108089b42b738baae28bab71aa7e6fed0ca8f465d269d9133c35f85f4578171ceaf0a1962ec852366d2a6c66627ed14170b5f3673233e68d7b03f9945eb8258e4ad6147929101a18a11ddc0c8884a043558a15fd7dfcd8a9375595193886d734c88358df2e0abb4998185b673ee8c6e639b534a6b233295f535efe67438451a32ad2309713f98102200dc86c850515a2c11c332811468b4a8e4ca4cfe0c0598270211fbea442ea0226d7a94ac1993afa438d7f3e04b373a73ed598e076171c8efb8b012c29843795c32723eb46172a8db3e447d38578b2f53b16ae7ced0ba74e0e3bba5e3e24aa154ecd0638da5b32f42b69325d1ce98a3e6c1af8d8053d1b00938a1a9f776c73a63bce40c3deaa6e6a3dabcb52044c57ec9fc4eb2f0c8e0c53b19a85863a83ebfaf17bb35474e9cfe860c49774753f0350f168a7f7407271a010ac930151e63eafbbf1543de37ea0df5ccb2863188a3fd01701dceba46d165ad4476e30acc8e7cf5e0457b2a6b201cc7b9454cdf33e68de422c104adc97f38cd44e756a4fd9711fd475aba536cdc0c5edf14b20f276f9a420910a7a1b7b6f851e8186a56c96e35f8f65ab7ee89baa42fdc4b97a7f8182ebc253667859694c1341f28c19027f552a224fc167eadae1dd376537d6e8847d209a675c9d51380d0fcad50e3054821e6fa62b65d8735ea5a465383528b7d1e67796ffd689a8e8b0298d5b3607c1ae27332a8a2ba2573bffe4600090a5cc740d68d6e8265e3c5d971e6f2acaab5a9bb79bb2f9093bbdfc92b3db9773fc142397e8e3cbcf21f383eece25e93cd8049eeed7ad945704b505a62179053fbad5d6e7a27693409d79b50da49e4a2c6aadf198d8af6b42772642daa8b9288f9af589d9ceafa61544862d96bb8f2059cdf7322b83a203c9506954b9771c38656a6fea8d93c9ca4612247df9511ca6d82ba6b8242e783106c26943e411763acad19b75a24c1bfd47388b73153c9a6903a48db00b67d134eea0196d860480318e06ba5e9a73f9efbd731732f8c85580b54eb2c97f130c19defeea37e224be09f61b2ec2d7760d77566f4b15a2c8a51ab0827b702e6a28f981b0d184b14b092b13261ea53aa225365df4e84a4098f0d00204b6c0e27f1e024306c0437878ccf5ae7810ac0326ab3134b4f8c7f471ccb4a49d565532c49b3e9a5c57a0b103240aac6bc26c3bb46de8fc7b621321c5480ac133d02cffbc95d65a9845220a5d2c54676ba01c79808da1b93986fbe944cf6ce01502f980f0d2297a977faf17c00989ffb39c550ebf8b3bb69a4b7ea0a3342d2ab3ee59147604a58a735ce57a867e8ccde55a09fbd1c1172442848264486bc359988fabd9285403e76a5eca2870edba993d6c9aea3107eb905e3e0a2bdb6bbc60fcd01788cc62a3c851365df274b8a3b543352f21af2b6d8bc473be423f7b414da42bb97f5c48f5a4881caa8d01c08d9c5d8236c91387e70c2379317b6f0971070ef026a36b5109c3bfaf37407ca253d87eac326f8970a8f8238972e0c9144c9c6c7808a24728f9627753d34c28455720a78f82a2b44b94422c5b17b2281878ef4ce6b5167ff06c79ad5d4c991b4bd34ad3e4fa6a5410305b4f15e28fb08ae8de542e8dcc4cdcf15521d065de83b5baea42503ff38ec3ba78dbacb29a04234b488f94bd3d37d49d89068a41bec52cdb42713a17429619a72744d38708d68172ef72f633fd4adb95a08e6f60bc7d225ecdc77e85289c767618eb8319dca4ec671a10e02df450a1535fa85055bb3aaf7da0959339ce1ac7b9444a4fdf1b6515146cd056d692de6ce0fef56b2e057cf3b414299af657c3bebe2f6d8b9507960b3dd866ee990d680c58a3cf48cff83fcb39ff4167aa606225e183d7ec967698e6718273c9be67596aa2f2a5ead45b877c0f8869cfcc976a2380125f7d0a0d239258278161f72ece7276da44ad42edc5e276afb7f3c06c2b9ac9a38e4a941a73678e7443e917095cae48685d81998f02df2ed8ac3a7212988ffbabfc4eba0c73c1063fb0f91be73b2b390031a6357d2a6146d56ac56c7e72dc226792e5fdf96a973db5aa1b4f76b4e53d2e407ca5d05bc0fa05d0d997c3aa05998cbef0d9558aca05eb0b6d011261d577d964478f4cfdf822b21b5d6dd6f7027cade680067e1c2933c510aea0146bd960433ce3f133a60c1a4147802460e008439f0344147244a34dd1a5ba1971e45ef4a7d3adfa4b49a9eee25502a7b428e49128e3cf9b8e52c19ca1218803dbc090629425909525a4f5c24bcd84f32f8216a72eee7065a6d5c1f50fdc06abb1d24fabeddd5e9087b931913ed13c2e689585e2aec022e6f92abf65d3b9dad5cbcc6d3173177dc6c46abfc9f135b28c11bf23807f4a3dd993ea8332b4d7774bf13253bf8ea9823b9037a8b858d99c17ed7a2665f1daddfa541b93278b34e4ffa14c875ac5a2d9a2e1800942f18b9006723dd971f3321bdc399761eb4e3e85ea36d950cebdff441553829a8d8de9db960d87d386f86a720d4ec897723662c173794255bee06ff176b27ebb2fb4b8aaec08f1f5636887cd54762b2446fb0752a1c996b5c8f14302e090b2b2591dfdad9d36e7fd93982f9004373ceedf19e95b3786761acc84b9710b352a535338e3b75447b22c0874137415e7b62ca21ad36df1ef388c27ab4dac2237a6830a85afe1ba4b679bb43ded918c54f4e2d19ddcacb977a5b1294f242306377547c021882b891492d680f4fdcb76432d64344e1ada4e718f9f1d9104192ee2a5b9344ce31b40cca8aeb2db5774617ee67d21ad549eb10e2e2b4a825d4f929418d660cc805be6a274384d2c903e5befba1fae82ff0a8da2ea2e0c74c948f67457e68c4468ce01d1dd348c9ed47a51ad3a70b9905ba0cea4b47d9f01924cad931e504f24291d9afd3a75b3a333fcb99fb965db06e03bbbe7fcf14020a025af7cf9ccfaeda8dc29a61fc6822f14ec1c4dbf6562b3843e3b96a95d1c65651282baaadda200a081e33b06ad5ef7508134c7c7b74b0814ef54a7c510a712e1685dd86ead0b7dfd46ae442918a5519156dd546b805d42b799b23daf585291f41e146a547101f87e1d981487875f38b11f1362a520bee82e69722638e618fbbc23cd0dd037c6cab1443a4f004ea59d2b6ffa8c825e6bb553cc03bfdd4631b17d660d827a99526bf0309da141b04f465606c7fcb033b84cff03c3b7d574bb5a207a8da6162c42819536e59a0166ff6d59592098b216b4cabed5e9a84ea8c7517c71630bc1e05b25134b97479631498495e849816c39a68c439a9dc0b717dc50dc136b3c7c84997306977b087a8ea3a4d45465ae640faf364fcdefc32d6aefbc8b2bc0530a3195fb38230f4071db3b1a1b002371f26c6b2fb6f019f15a41d7d99ed9ddfbc6ac2b889be3ac8aef74d40b4dc356a7c22c47d94b468a40209b87c5fb27da906cb2c0961df008ba4eb775a7a85def3deef816352962518fc778bb92be27f2da9aa218b453b4043b306fa3d73bde20baea092021fb3b24eefbb8d5ebfba0a80dee83a859352d2bbbd2b21b973e4bf27c6e41c516f24ec407c85897fcf1ef4fd54ef75d3c64eb6fee46948927891310aa8f4e50b1a2ceebc76710b4a18786b33084a1449d30794f938d44185492125bb0dc24a69856583809ba8336ac95ec3893cf65c508dee3820affe4661170818d26d5613a28be393242aa6cc666d9c95f5cbaa150499f418e1871ce824a2acaa802f83753dd83e5810fd4277cc6b92b13481c57e5826c7e2c6b46482879d856407cba843704e47047c8844efe68c215b02cfac454e82666cd926f174e64b37f5cc58338cbb89704c2328e4929e5a9c5b9928a4050920bc414692781afa5c67e6d53121f92863b880f6c91208723dae6bb3993d367aff4c3e42309186fcfb42bb70cfd399fb89a0b8894bcd0a9a15b16820e9ddb6d96eca84394c3ac28bd21c34ba064f55d49ed498317c92b10b0de0889d21f768cbe60e522e60a4ea5be0086e5a0e9cb1c9b8fe5eae51200875e3242791c9c98b5afe9eacd085b8c50da71640d2bf599dfe97e5dd7060ac81eae5ce681250875ad9a10f18603bf436174826fd1b2a6ec576e0f76098695559c5c10b731f8327dfa24423030d6b5a4e2606d973a101bbcab6a2c87f53f5b1fabfc2d57783311e1cf478f80b7a8c81485705c834a49c418592927a87417a14c455b28411b2bf5f82075b45294bb2aa90484be85df2f4d03a28c9acf415607f592f08d91f3e711fb4030382e64f8d8b574723c012ac45990cb98620046f98e7b6eb5ea1e8fea24c39f57442802b77158aa5c18723a974584e31257bdc17116f0710bf1b8e1435e6ce53205d051ff142e349b375dcc4bad57c6d8a413fcf91bc653624be9260a0b4768d364489b4d4bed78babdb9dfabf7a058d6085fab9d720853e807d5d9a3fba8e28d0d9aaeb735bf225aa11f0f2362813810556c1e44a9f32a0686e43ec64065dd9d81c92c563531907688c31cab1f5424312f3cd9c1a69664a1f63acfb87a5b3f98aa1aeb233b96538f1d65b4d07e4b904293bf2733c451fac502118848ff60d5f607060eeea21f0bb3397714761b2652dc7806f8e25b1a71cac99d1231deb4d2b1e1ffa510e2bc0f35837c877044f1e7f823859cf72d9718b3423656303859cd6e9a044cd184e0345b953362a5b32b5352a2ac514aa94795f19b90020d9f4e73fabb6d6bb4efd65e1a91922d3ddcb0ee13f0c336fabd1fd529f9d49be5f93ee81ff55e53ef316a0e307b95906b4e595511ed9fdd1868276341923eac54d60d5c4d2c26bf2777659117ad11b1daf4c42b78d8a7ad527a319d14f231968ad4b544dc937ff5b7f1f148bf00c4c34e62c2eabecf85cb4e012a7d03ae30eb58d5f2fc717deb7db40b8f4e2a87625b7e0fbcb5bed866702c0282f9638afd8fb9dd12a093b771b080d9be69b84d9d5d65277a84f0d0515671446a5d0e4cbb429c9bb7c33147d7a7a7bba9f76d92173b2eabea097bd05f6c590b8d27eb44046cd283b4b2452d63814bfa7992d568dc52f30a45061a480743699c6c59868bef5d1e25797297e7f91a42f50aa102129a69145199a8b8cdaa7f2acc8e0caafe496de211f362e309cc996fa1c158dea062a8a6e29f0d92b13f858c2ec8306275b8b8a15c849981668e7e4d13c9102748ecf917f4cffca2605282fb4936caf6d111422e72bb71704d96a0f0ca8746ce533b5229eb3c7f0ae09779106ccd636f448485d53a035cb87ed880113cc7a62ad724820b82c348f1d86b68e"
        )
        val state3 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, normalWithHtlcs, TestConstants.Bob.nodeParams)
        assertIs<Normal>(state3)
    }
}