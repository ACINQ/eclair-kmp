package fr.acinq.lightning.serialization

import fr.acinq.lightning.CltvExpiryDelta
import fr.acinq.lightning.Lightning
import fr.acinq.lightning.blockchain.BITCOIN_FUNDING_DEPTHOK
import fr.acinq.lightning.blockchain.WatchEventConfirmed
import fr.acinq.lightning.channel.*
import fr.acinq.lightning.channel.TestsHelper.processEx
import fr.acinq.lightning.channel.states.WaitForFundingConfirmedTestsCommon
import fr.acinq.lightning.tests.TestConstants
import fr.acinq.lightning.utils.UUID
import fr.acinq.lightning.utils.msat
import fr.acinq.lightning.wire.FundingLocked
import fr.acinq.lightning.wire.UpdateAddHtlc
import fr.acinq.secp256k1.Hex
import kotlin.test.Ignore
import kotlin.test.Test
import kotlin.test.assertTrue

class CompatibilityTestsCommon {
    @Ignore
    @Test
    fun `generate data`() {
        // generate test data
        val (alice, bob) = WaitForFundingConfirmedTestsCommon.init(ChannelType.SupportedChannelType.AnchorOutputs, TestConstants.fundingAmount, TestConstants.pushMsat)
        val fundingTx = alice.fundingTx!!
        val bin = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob)
        println("wait_for_funding_confirmed: ${bin.data}")

        val (bob1, actionsBob) = bob.processEx(ChannelEvent.WatchReceived(WatchEventConfirmed(bob.channelId, BITCOIN_FUNDING_DEPTHOK, 42, 0, fundingTx)))
        val fundingLocked = actionsBob.findOutgoingMessage<FundingLocked>()
        assertTrue(bob1 is WaitForFundingLocked)

        val bin1 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob1)
        println("wait_for_funding_locked: ${bin1.data}")

        val (alice1, actionsAlice) = alice.processEx(ChannelEvent.MessageReceived(fundingLocked))
        assertTrue(alice1 is WaitForFundingConfirmed && alice1.deferred == fundingLocked)

        assertTrue(actionsAlice.isEmpty()) // alice waits until she sees on-chain confirmations herself
        val (alice2, actionsAlice2) = alice1.processEx(ChannelEvent.WatchReceived(WatchEventConfirmed(alice.channelId, BITCOIN_FUNDING_DEPTHOK, 0, 42, fundingTx)))
        val fundingLockedAlice = actionsAlice2.findOutgoingMessage<FundingLocked>()
        val (bob2, _) = bob1.processEx(ChannelEvent.MessageReceived(fundingLockedAlice))
        assertTrue(bob2 is Normal)

        val bin2 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob2)
        println("normal: ${bin2.data}")

        val add1 = CMD_ADD_HTLC(
            10_000.msat,
            Lightning.randomBytes32(),
            CltvExpiryDelta(144).toCltvExpiry(TestConstants.defaultBlockHeight.toLong()),
            TestConstants.emptyOnionPacket,
            UUID.randomUUID()
        )
        val add2 = CMD_ADD_HTLC(
            10_000.msat,
            Lightning.randomBytes32(),
            CltvExpiryDelta(144).toCltvExpiry(TestConstants.defaultBlockHeight.toLong()),
            TestConstants.emptyOnionPacket,
            UUID.randomUUID()
        )
        val (alice3, actionsAlice3) = alice2.processEx(ChannelEvent.ExecuteCommand(add1))
        val (_, actionsAlice4) = alice3.processEx(ChannelEvent.ExecuteCommand(add2))
        val htlc1 = actionsAlice3.findOutgoingMessage<UpdateAddHtlc>()
        val htlc2 = actionsAlice4.findOutgoingMessage<UpdateAddHtlc>()

        val (bob3, _) = bob2.processEx(ChannelEvent.MessageReceived(htlc1))
        val (bob4, _) = bob3.processEx(ChannelEvent.MessageReceived(htlc2))
        val (bob5, _) = bob4.processEx(ChannelEvent.ExecuteCommand(add1))
        val (bob6, _) = bob5.processEx(ChannelEvent.ExecuteCommand(add2))
        assertTrue(bob6 is Normal)

        val bin3 = Serialization.encrypt(TestConstants.Bob.nodeParams.nodePrivateKey, bob6)
        println("normal_with_htlcs: ${bin3.data}")
    }

    @Test
    fun `read compatibility test data`() {
        // data was generated with lightning-kmp v1.4.2
        // README: it this test fails it means that we cannot decrypt and/or deserialize data created with on older version of the app !!
        val wait_for_funding_confirmed = Hex.decode(
            "f9bdf6470b26f4b3a66d3c121b22083cc89be49efeec92102e8d6914a959fe90b21e03989c675ea3ef4d7e8153032de1dedeb50616fb97cbf2ea8b5754b34f7a262302c9efdd635cb9827bfb124868d0953d85c13e4ed2de5d01271f56b93fe10e4433edbbbea9fd279ba0e11c7ff781e265fa72dfd48f5a7523b3e576bd8daf805e820aee8bfd10fc23b3ee08c856554e6d448e770f82838e784244229686eda2262ae0ddf4cba54251df56ab00d49f6672c292ae93387a8ec1c48271d9bc757d6dcddf0a374a3046bf1bd7ef1cc20561681ef615ca193ee7d750c132a8ebe999961eae98ca767d4cb18a17baaa6d4b02cc44b434ab8bfcffb55f2974c17486e7ae6672ed91b0ae9a7b89925da16f5edc997265d0f2afdf4b3e10849f5eeaa549cfffa6e0c140256a3c65d7f2366e8e3cb12af85f0380e2ef89e6ba5a08fe9b56309961fdb3227b6c7b77e1e95d734b53501a934be821ecd21b75f0768cf83a0c064ead7df89f39aa364cc1765fc70f6a9edf0e86f2fbf99edb2bccab5f23c055650c8f5e3913d8891c5b6fc7ac02161557ef1a58efe9ca86ae242a23652cbc14edf1dd978bc6f8cbdf96b3704194b9dcd8d50d212c7e17a27348ebc892e63d3a1e54f413e73f69a2b60d8ab4a69ebc154391b72ea54c0bc2beaea5f0752e6fe11d2e6bebad4570730c43607caff4f7d394edea50b9776a7206859a2539a0012f1cf9ef1351bcde8d123fc210d57790828e8f9fb294bcb6303314fa87a72eb7d6aa08d93be5e152e223f5802c9ca0502114902ea1018cb9a116f4a5b97e16faf58217841e6d834cd315e7d2b255764d3c85902a9928ff1f4e40500f39af845f5eed55633e8e3af3e965fe7cbf20c518cb5c25b277c9e4bf6278115bbbc9899e169727af99e01f1069c4fc8a3628caa3173c53a8601d975baaff8668f478ce12f4938b58214d1c9f1f7044f427697c9d3313600804e5db320f51dcf390f59863ae52cb42adc91506dc308689b6686ef559176db9060c2f904a2ef8e6005e1b148b35f7107e7c6ef1f5c8ef12a5a1961c18bfcd0dca5af9577b2190abff7e9861995fdbd2cc2a8089afb13fd99b4c11b2d44847b416fdf4efa57cc69803c826eec79c66bf391da4026c4093bfbfede68cf1020a8c2987bb151bd14df47111637772a37050a7d4ec384b136d43432e784ef49a296d78e1dcd83f1d12a42dbf00672862c83ad03ba9f6e770c3e335075c2f5f175e7e5c5fc13d223f90148d256c946b74866741c14f1769e321f384dcd91435f9408fed88e74d5a237e9be876551399d8065722d115f5fb98fda4bbd169509244c77ef38053c43b554704f240ffa36e1a33d659a1784d17ace49f8d65537754680d7f088d55495987e01579eccaceceb05f9bb819c7b3a346085d293887992c9c6da86fe5f540eadec354e6fa5e1f5f157edfb70857b16eef7532d5fa141f379689224b9a3c7ef7ec05be478ea9eb5d81c287cb93184b5699233606fd4777737d5d7c9c507f6e5f5fa4621eaad8ece4c079b65b8043b4244172967f142e2ff8b36a166e44939dcdf7713517e4074f3c7ee87c8974e2165c9c936860f4cddb190b178e0a1719d02e38c22393167b455432fdd3e944a4b222eba81166d68803b83ec0616c9cca58445f8644707553dae0b64a21aaed7d81c1bf1382e4b2e2e8b92105d998c44a3f3f86350c9b0da8b3ef1adf14a37fc5050ac75c6ea41a6331e04ab5895433138b4d145de85e26c99fbf33df9503e9d3006e97ce5221d69fd892193c915e2ba7cf3a73dcd4739deabcd8fadff00c7c9f0ac58885f2360ba50e40c3054d7ca3fb517dd2f3a2a8e8c2ca2eb6715c68418f7ac4c61bb8b96ea9042950cd39b2a6f170f5050d1e94cc26b8552453886ad8e9194e6b97461f8867d5862506661a5259e300e9e91455bb2db8a1e379dd8843c6444e724af887233f249c622a07f92747b76196313a43db3eba49bf12c0aaf0470487f7b3a847ba79dbd09fe5e8f9afe5e3bb9b08ba9c87ffa532197a46b9b5328c1f602cc969c8ddac4228fae68da7f5a9904f22b888ee133124a0d1871ab2860369d07d713aaf854df6f0ab1b3761abf978495a3afe78153baeb76c405412db347e971375f0970b84e3c20e71e0ad9a5b9ed4ac8a22896074a7b53bb2d1a01ea27c896efe2a6b0336f75172cf16bcf029ee298b6015d28ed7126a1a3a79e2a7cb7e2bfcec7395ff2f792e237115cb397eee64a81fd903e6d2e17ce23f13f79bf3f1428b01ddfa2f858fffd96c635ad3dde25f6d4b8972691181e90e8efd98fb8d00de7862c1e5b3154f6f269ad8a5a7880c813012a0242686b0814b0f223a98856d6aeeebce996be5f32274df39b2c1ceb117d18255e8739cd004815b849cff3141611679a0601f16f9af9e4c5678753a545f770381ce747ad675810550394485dbdc28be0d39b8669f53807f241014f0a8a5644f4463a16092a7a4e1182df6f64c1ad6b90401233d86d6c74c83e9dea9e47a1869fc21b12690ea516b2dd6c9b6e38a2919c51efe6172d3e66e28d01cde93566180603f48534bc69ccd709c369e3312b05c7c6e85cfec560f468f85276d8171574dad750325f83fecf5fda796e1c5763119bd03bc4f5551655beec1aa1ecc3cabdd028b83e1ced9966e7223294751afba90b03f1cb110f77dfb5b0f3bd6de5465689fca7daeb58948aefdf791f84b9b59373351f3f88cdb4f2337d2bffc103653f6d74fce5948bbd578fccbbbddb3869f8592ecbaa2d7814029a8f31730aaefc2f17ef3cd358dfa929b466587351cbe78da73665134569111d7e56a51a770ba5ca6827c9697351a8653c9073ff809421d51eccc5636158cd4a50aaab94d1a30d5ede574950e77c579b2ca8ccf8dde40b136ae2885be22a25b382f5dd904d3bb0d957758c14cfa8188614abf69a0fb2955971f32eb121136b17df32b984000558ce38f229c35b738c7eb7bd03c6c1ab946c04a5ccc8eff3b9aee70e166cb42d02c6df8c6139ca86309b06704289e7023710ac9ab60b0dda98aa5e0e94baa44bb28635ac284f14dd41384dee02faa3728c6484723d7ed02b0a92aaf0a4ac5829882f2205da8508a832696f2f8d182c00f6f795fc5cd71ea778d40b460e81b572facc9365e64ecf2777175f3fa273b9336fd8fbe1a3a6b8e0f8302a531627605022fa989ae1f9d7aa2cb3536c110de1dc7caab756d8fad5a3b61cac45e52a93e03ba831f4c6f6b99fdf84b0d279e9546c071969a7abc68322bd3b42135a6e425638ac5271e7652bddc3aa59dcedeabc3ad0dcf157cd6de1b648b223e7f61e3f45f08499303fd13ff0f68be52945f61a9d5f27898df5aa3899ad6f9016ba604abdfbbfa4188f44538376aa08f45fece4ee23482959006f120d801cd9562fa4de30407aad054c9c6cab60a10c4f19755f4969ae86d37e17a04afb0d19a89a3144f26a5e880119e5c54eabdfff71f50b0c04a2711f5bd501db7550ee62cd548398782c0160b73146b20ff178587f14e99719b4ed1b5f86124516f8a4e63e5dc4df6f7e88bfc70286fd820398a4f73b92d4c29c36d50b60174308ec48abb6b473ce3db6f58918a8d7294c741c8c309b01b25792185dadf1820de92ba4f976918133eca20666e687043241fd2129f00bd8a5b7142ecf8e8d5dcd1bc07086a1ede02263ae325bcd561401201e6c4aeff8c3dd773efc9253a39cb721c334943e506527924183485d689b8c49f4cfc96b169f5c96d9aee32e1a5ba3eac6a344bd490c973dd222ce2379793e5afca74f56bf694741b7d0942a1c4ff90d4eedddfdc61036b1166bc9de2de1971cdb28140d4bf9afd43d1344a3d32379da524db8ef103e33d4bf1569ac18605f6f11ef7f803c2f23b29280636c580e7e563372eec2c0bd494032796051d899a877c1febec1a2357db8f8a6011183cad74c63e2e67b95374124d8451d820ca8109e57603e5e317e8b706c5ba038d3eaa02f8d2b01add631788e8b94aca7d97d4c069fef4f58fe3b556af7a515932b153b2cbc64db69f07c8ef168171b9b67e414419b6bcf13f0e290d83a22bf5fe5e3dbe7460aa227dfcc62dbd78dbb283c6cc3ec22aedb54c4f3b52ff96700ff47ee9a9d9afaf0763253d0b7582765f5a1ea36bde199c6e1b63c63bd8059cbd677d1ba1c5bd603a85ecc104120b66069830fd3a7238610cd349493fdddfc45daa7c554798420eff7612ad5c0eb19361eb2db11f8da866a13408f1ca4b84380695ba454f53bffc0a2ad35edd998293223ceb3909e46d1e4f76f74a79a2cfb8fb78dfa9af9847da95832139bba48797eb2eeb48945010116a2555476d4d7e98e79dce7aa8a8699412c8aeb67ea6bef840075bfb3ede58cd3a69a99c2f4f379787483bbebc03d2d4355cca5276bcda9986dac6e4834c9244be3928d639db3592ffd22417ec3746e092f43f8d5ff5c3c69e6be1ab0ec3cdb65d741606640158ca34cda25a87f8e98b444a02974e0835e3f07e9d237159cbed4e23f640da6c5cee65f08de8e40bdecb7caade29d60978154e6ab72cc909570f963d41ace6f71b40fe948aea552ca71cab378f42329497a71076b78c729a51faea918721a532ab418d654a813a273f594648bf4c96376f21b092dc676967628449e23220720bdb28424a86c8e243346071f7327374b7fa3494360a9cdd3844ff973a863fbbed60840b475a708842743e2fd0513fdecd9e151fdd8083eb9cb832cea2df24d923e8f21b9585b3948a994f9128402e26ce7e0465c0b8f770977aad1ffb92e23b9ae7fbd85370bb7466062ecf4c4ec5c9ae9f97d8f53925aa62873d917d2fb63d08bf7a4d3d3c9e80942cb0f2ce69a0611cf6919515c338ebff19e2d8fe91a66383834fbc62c4d16cdacbe894551d955ae64bf93e0681a63b5e77369b3d7fca418723e608ac3b359ea897d0620322fd430c015a8fb77eb3907be3ab02734195274e9de00afab84243f5e0e8d794f7099c219de49abe8e107ceea034461a86497401c96ab2a8abfdec54ad2c176e1505cdb074f943d3bf25d2e63d1881b616c4f8da17c266b1459aac8ef6f16b780643904c982182abb0f6754f73c6f42dd58868f8600bdc57855c5adfa26cc1edd7b566d46c8d9adf64694d95c09635be8f965da288c51ec5c722ab906894b3abd25cccafef0634737d8acccf39e1504c64260af603720a0905f0edbb3c6f408676"
        )
        val state = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, wait_for_funding_confirmed, TestConstants.Bob.nodeParams)
        assertTrue(state is WaitForFundingConfirmed)
        val wait_for_funding_locked = Hex.decode(
            "aeb718b63ff2064caa49b3f0351d0debb5409d366a241aa99707aa7aa7e94f0148cc3e5b41085184a2d0ccd50ae6d76d35522023504b924a6e94623b523df91ba3cc663e0a5921a00078b95f248012dcf12b79cc39be900a7ea5ec0c8f9c8477d8e8d99bf6fc1c359f624a401d2389afe48b864120f8ae158f120d5f4803d97fe2917bfad1961602a12899f32fcb9ced8a28a414b3a0d0b1f81bff16a13d8be2f86b6c8f3b1f0b7025b69635957bcb165e5fa86fa9a9f35a7399e61ed63f67c64fe5a51866655ad47f97dd4749989280ed423d4a8b816227a8e56a3004b6da7ba9b16301a2e1206dab4fb1159d58dcac9b49ec94eeecc0345dc08465acb0baf3f52553102f9db80cc34d1e7cd7cda21b7455a96a224dbba2fe67afb77ba70961bbc3337b4a1f6928b2ab9bb8c9e0e30df1b7814b58572255aad05951af587717f2cbe0ed5535c220be591894f3bfa95aebfff706eccb670caec48cbc04c1c7f5f9959b65c18f99eda68e78f0c800774d68cc68cb8584400878e9fb575f0f377ee398155a78ed127241f2cf555932eb1c1e7ca649c3f7c53618e4b8d1c12f7fd35d83dc958c6e437e329416ce71b9e6d6339d2aa68dc230e6dac6e95717e5c74c3e21f49882fa54cde5be67bcd95721ff821cc6bc952fa36dca6ec2d336c6ca99d285878cbf9cff953c92bcdcd78838ec6a86568b50f52e08564b9250c90b7b7f2585e787fa64b75b4cdccc039a942279de90c6be821f2793f67fd04101c77955e5a6c38b5c0997731a6ac3dea1b40e4484d28603b3fdcd8b700fa63f7cc05e19c0d49eaa44a89c14c8de7633ec9950d4f6127f0f750100dd8293c2922d50be6ae62c8385ce60597b69b63702a6b9d46506e2c5d87fb52ca5dc4e071a0a9c9a8897b813f61b22db54b2af881dc5ff93b5eb2a96d9f0713952f910cd27ce7d02e436a2e172d18bccae647254a1c480fa48f1efa0ba6ce95f0449c38bac813d97c8254e75bdc5f4c1f11dbca598e29f999124ba9c75214e54ded1b2004b8106488a8619c8db36ea7aae2ac724c85df35fbe565116e0391287a7c41dc5f3acd36a68e31af97b1cd796d23ed1240dcab247f22ec6782f4e16a01183bebda2dbd0ec9fe3817af84bd376d25493f3358bfb3403e71a4246e21fdd0314057c730d49d62925d07bfca84ebea2c50fb7f68ab20b1e4623d8c8f102a03621a3b63736d82a87976cfbe7c1d48084fb57c6b77614c47ed1dced68b70cb159c218fcff4434d459757b935989b3696d12d23ec0da20f1c875e1345c74893a9522ac2e1125a5dd59a4dc8ccf428b6ed647e6936692bb843c669f361e1a03863d5d861b448cb6e8eaec879eb52bfca8fcf093b781341f8b0d861f5a40c1bc334a7784bda056b4725f98bae18fb4995dbbbd7958b4404526df7adc3564385364867af1dfe868cff10bc921802a037895723a2e0b769274880f78677436b39f42ad4dacfe3ddb7b8232beac744f097ad6666530ed24812430dfcf090fdc9834aa74c5ae206cbad3a6eee4799c2ff0099251920803eb621b8d4b214f6fdd88cabe71b22f80ff5647818bfbc12035644faa01bdbdce45cf05561c5a1a1bcc5df18c13c259843881593d7de5b56d1894087b10fbd270adf49a4b3ad6e152c0ac5de9ad2aa473dc148c1112696e372510422844ad8bf412d9b84c711c36c3cd2166a88ebad355c76fa79bed8c08381fd1fd96dc67323349aa5d699450adf1ea6a13a0980f1de7cb68e0f758d3ea7d0bb92159b304f5ec0dbe9726b50d1e98709fe852a02ccd9383914666883356073629397e67864eca97f3b2a8c10c5c6486d56c0fac7b2c23a4c236c7e1514a548235f55b661c322b14202e718f0461a67b8f19e2a7f6b57fcd077dec349c311ec99ee8ed561e61327943a95c6996ed7f54b68ca8a732d53a2c287bb474ede4f540f03e4b2e20d3a0e43dc05779dad5f9579c6140e66bd570001418706181f60dc6ad0b008f8b87c87be74716528413cc7f0b060dd21378a68c939cab9f40af158f165f3b69e2122e9b5cddf750594cf6a0065d53cc92426223dbc6c159a3a5d89b8bf6213b54b9737e15cd045543b271e7c8a421e5efbc58222b16521fbe93697db3f10d2a1cfeda2df81212da883707d55b6541fdd824446d86c42c55b2557fd1c340fda5938a1c5ab8be24da99103d311837d248d1b1f56d7dbc313af8377abe73b77a9bb24e9bca255864eaa73c1af6d982d850713c5769ea626d13a3a2a61441318e9cbae6fed02550e9bb91ac4803f43a90d619ca0bcb7f64d715dd6861e8f15556d2d1bcd49374c670aeedc7dad046e45dfbdd6e40bb66f93995cba4ed8fc0f30b50f781a33ca531a01db78a7260613800df1ecba1051cb0e1e0e5d0d2f74289863bb6302fabbdabfe6d318d132ae86a2f5f775907a50fefe23382d6d4af440a73777495c2ec2e8edc6bddfdfa09c3092739c19512a6cd6c83816dab156dfd03f01fc7e1a8f21701450d7589fcb011aa6ec14ab2e69d88a96390f8d458a1bb5324fd62fcf1473904ab2cd23638609ffda029e218cbcddcd938125d4cc8a08cdcfbc3035d8af537f6008b8d8bdff0ffec013c5fe383c0d6d84bf57f8c3e3fc4fc111960065ccdb1c241be5057b59b19dfc67d8eaf58d11a0ec0daa7ca26db5cf4ec6c462453164075be9b45c5eb69d4491c082180ac9b962813abf9a47b505009d139e80f89e7c81bfafc15c74b96eb47e7cc3b61bfb0e4aba5427b62a1102b8e2697065f0f53336efeef9d8d795aa7fa2504966058d7beb6ef89dc2ce1495ff9e1a5b9fc4076317caa51b78ee4bc33199ecc737c7aa0750920eb3f9a2f1aa46f162bb64af5a071971b347105b07188a15d667b8c6d9fd607d23ba74b4ddbbdcdce9b7662357af22356fae8b9967a1aba4d3d5113fdcc1de347ae939abf65bf974db8be724fba056d6e860d5ddada5d686f891d1b3f56d35575ac0a7fbddbd63c1b19ba1ee2ec292c338f796a5e160f43d5422a3e54a4f07d498debe4c048e7e58197c08444626d1086ea313617db6cf0252039e5af888b6b5e1802984a2fe0eb00f204848865e9bb03957d455440fad7f5a75b940182e155bf162d4e9f20839be4579a837a8851cfd54c1c813ba5ea19cb866dfff7752cac8796ee090ee319f3b8591966d7fe50bb4af9247753baa6a49567b4e3266185b7ec7c80dbb1c04c9de11e2396b154e58f95ad8670d04c277658e27358dce1896b12ae7364f8f011bdb20903be36351cac8524e7b02614326fac6c25035a85f1f49f5603954851b9dce74e39ee844ef1d90edceb02dff3e50aaef9ab0a06e1aa9f08f63a9ff16f1481d5089c70da785bfc40e6f7ab968d1a648004dbdbf82544edf8d89040099b0e06f30f55fe581baa1cc3920dcbee08e716b44ee1d28d8717fe062d5e2e02f25ad8a5604a15f50d459cd88cba69c3d745ec24076ccec8be26a6e28ff5627158bf933ac832c858eb79aab6a22e00baac90a9246cdc17de278ad112ea77e028a6c58c7a004801cdbd0eec3426d27aeb940fb57c78bbc366734ad58d9687ba527b4f46b0b82dc905c9cb378dfc3b3243c39a1241866816b13ed344a122dee9fa9393d08030b964660e73bccae4755016c5dc6005e5d44cf25d5247c066925c3b622eb98d0e910d199b6631ef1a7fea6f4055c4ee65893ae3090dac82b4c51f2908b996e51ca749c58eea93289d5ecabacaca1648c12ec65f19f8d85030ba72ed034ea72a42699ea4676aacfadbe89737806799c8add5eac35108c86454e3d40679bd217448dfcdcf477e3b645b8253cd68a77ad19926d31166cbba94dec90b3f87755402ff17c194c36e8af66c56437356ca32eeb3493c574fe359c55bcecac3dbdd33aae5122e459f272c914f970bc45da07c20995e00e71b3053ed77e33f41e80c565ff17b7e76ac833c39a4109b7215e5d8399c8521241fd0620347b67428778cafe340718566e62b0d03fdfecaa185ba4a053f06f781d894f3ecdbb787e5f865f760bf7d0e1be8f7e66dceb1b9df4642fddee9c4bca0b9a4ee38958ac7f74a24f0b6d83552fe3910de2f3de3abbdf3c151fa8ce1e1281682169e430573a9f47b248c5d94ff946e4ab912c3677398fc9d83985973370d67d70c6a812e308956fe73f1b45c5481a934612e71bfb12e467aa6b302951987dec97e37e651f946a6fb31c91a4a3ae4ed20d4c957d2ddb9306be768601fcb8474e52fae65e843b919cc3735d6948ba242eb2ef088884e2096db0b6bd93ec60cd0bf62d8dbdb9c75e957a7376ececa03453fe7a3dd26a973a8337c8b1ec63e8a4d58984c61171df367e116ea3a0e5bee40c5c3fae811164a90cc3248f25217c9ca6ff264f20c6232ab7ad5a07de75b247dfad16a2d8eb0d0928c25f24718cbeddec20e7755f20a6347210ce87508c03fd9cc7f4200b2be04562ebac432f3f6a7d642db9daca7c5712a523f26620768f3c63b8196d854a2ce5641310a0b74aac5b8bde60832678deaf29356b8ceab48e742abc7772b81d40abd8c91e68bc8cbf150ce0fdc5283a5129dfdcc4d4d0af0e4695c34f1d6e4a0c1a51b383f7f423cd3847296a258446590ea2fbceeb152c83cf6a521829241049b0d8733b6728f5a8bd961c868c13be99fd462ec88becf73281434ba4d29604facc969d7c8253101b4a4b87a7f2c35bfee2d2b13f3bdbc94d658d5282473743e16cead69534e7b33d241285d8b1ab1aa9050ac5a0ee13aa278de6746a3088185864ffeff686b9a3a1767e7a97e53269efe9b841badf225dbb05803e12fba599c0fb7553a85397464132fe9dd2aa252d72a24c1c2a4fe5cefd9087120c30816094bb2da4dd65a467b390fc155f4ac90122c610ec753307ccd59864634f410f60c31021bffa0cb345955770ce64e1fe15ba922cb869f4c3ea8467d9f6ee4adfb7ba7f68f7d434f4520c7297884879f8bc688d1787ed1334d373a58d8e7ae2570b4cf8ab3e738196946d19a9d6bb1829a0e4d0b2ec5e903a7f53255614eeb9e95d5db1151559876b3b964ff3b35f4f5c79219ad59b3d7d1d2b29f039ab243a54ac6178f7ad7e037596ba03027cd9f2a8e1ba7ff4cca456fbfdc3a5e7daf44fddb2cda40c7b96de2a61ca4f6bf57156bde50a5f7fd5ebb64"
        )
        val state1 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, wait_for_funding_locked, TestConstants.Bob.nodeParams)
        assertTrue(state1 is WaitForFundingLocked)
        val normal = Hex.decode(
            "27eab1a09e92b1d7582947e8c569fc380ad344482a37ac58b745226a0a134c5ce2df13102cbae54d41ed9c8aafdeeaa240693c700fd28033ddd747967a8ff5d58755cf20fb973225b83b210973cddcc1165fbbd66a0a7f5a45d5563fd5c3c5250bbc3ac9d143c6ddfd6a2ccbc7f3d8692ac8b8117a51a350ebd493e2cf2f3ebb91a2517ddcd921c686227b397c2f86569c73a838f81fba1db0d669eb52c1947bce5f2ba4e55f6d9fcc4548826d7ff49eca8d5ad796fc20023b9e9ccd91628dd386de2559daa5fa3e70f33f33824a8174839828d669b326c56ce1271e67ca8532985db17c6a87a9f68170bb9b9f84fc369f2a529d588c705723511e56e94264ef33b733d50466151a0d8960d3a018c2d57d9fd606d7b0fe01c73bdebdab94ff4750edc28d291d3856bdf064f772505638b9f385e19f4d7f85d694921966522b5bd1d9acd77ab7fa398f5259a72175f3968503947f3158471b3f2ecbac80a92cfce7c68d40c816ee4c28db1bd2d935bb79ed9adeaae1cf58a924f7334c155b58f0e7d4e4d0b4dbbfb72216353eda351d30063e08272cd8d34906010e2b2052095d37f85bed24e62011cadfdfcc4fe35a0e7e183a179f8a693e2fe0e5fb671e9c3c523b9bdfbdea3e76c10db8dc574d8d1537ad1ca54439fcaed10209dd8ec24b9dd8dbe198d1349262abd02006727f501ebc3ebf1132c4c13293c14855e6971ef107dc88fa07672e68bf9de037f2c5ca6c7275b7db60c580d96d6bdee6a7b1a3a80c22a8add1b3c505284b6dfda11770b479628170f5f518b30e9d6f453e26931e13d4b48b4c8d97f6e5a97ce549e0adbc7b84b3c739d7f68daa8f05d9b7d726a9cadb2a720fdf3c8117f9f0154e075e5c2235cecb1f793b218686d4f9e3a2e5bced8243660d6c214ed43faa3a0c0618f9552c808c202beb9f2fd61bcdb75e5fc2f42ff5326959c609dde411e8db2658a02defd1df847dfe7069a981eb4118a16686f16071e897b427649e6df7289af7582eb96f2dd7ec4abf4749bd20361ada5e4a7be10ee2fa9d996215842ee398e08c9563fdf7366bc6a8bc7f605a3c2abb0d8ee3fd917edc5c154d0764bb8058b7b4b188ac4481eb18b0ecb318abd253da8b1caad53bea1c9d37dfcfd1d223a9206220422263b727d2c6d209d1e36716bd31605877b5463267581559c2c6b79dcca3c63f04f11f14017126740af0979f0d39832f4a8d2b15fae6f5f981aeff864554b72f6c6c5648b5062facbe81991943bdda9309d975be98167a9744c62d77a09999c3fe695eb0cf48430d0337af1360d62a22306280d4bc98e2526fc5bbed4f32d38ed17ba23c609bf40b8236d1afe8d9589c661564a01e5b98da559297745069deb09d0d1c3835e494c77054063c5e037d5416099a04f0b34b93697ed93a2af265e4a2b38c4e62d9119c60ae816ffcb55446152d4070a64a057db89ec8b5cfde9e02655f7bb6521f2e4d3de75cb7a5556b294fb7f473272f141598385eba1765e3789d40e61b776c446484b526967f2f47253a0e4b5af84fcddd8cba9c55e11e2cc47f768b85f624bb60488fee470933c55a827987767ac8a81d8e0a5dfcef4ef84f7d323a6a247bd704b22209169bfb64923ae3a4f185eda84afdf206e87946add7f6c5f3fcf4e913c4e49fb2270609299d77101afbbf0a9c9ed211da68d852d9cfa4ea754f9bea26a8917111498b3df8739614acd06defb412673b7357503e053c07d2b68864041b77fcf51e19a089d3c0802b1cbbbb1d9c0d3d5e55dd0ab95b4c9a89161a1acdc0773b5e34d887a5a2bba5f570d6f7b3b87a294e0eeca788cd573748549d0de3cee86226be3c198e66705ba082fd58579f8a577b9341fc87cc5ff9fdfbf627119ba31121e6927ce6816854dbf813f7dc8c4e65e87e944ca2a28f150139d3506342d142382781af4d8c4d33c93ab6c15a2d3c29f41162ed14de776d662490d9cf936645ad2376bbdd221d81d6552cb6b9278f46fafe6276395f96e834e840433150959f9e9244e1b97f98b6630262d130a149bdb8fb00c72e8d4d347cb7f13566c653e7bce65f4eeb2e0538fb9385397cec4b34dc16372d4badc3dc3630c81bb4144b96a6db3e7d56974ecb039ad8e6af929a4e74776cc678d9f8e1037e238839d7da0ea695a46eaa89c5325fb99d29ceb6300acc624e1629b077ba50fddd657fdafbcfc99af5ad9bd75c8749ae32e28993a542c04cf622734d6a18483799d96cc4cdf337ff4ed66523f84902bc86aac405fedfae0b812a0f8d0463cf89c60549328a04cccae26b1f665d0a5f417ba7aaca7d2c1cf47ab5c8906881c59596861f1616d3df07c4d852d3f036d6652d5ac0fe9664ca10edbc95a8e0e9b96115d78ee11b5ef0317e38d74341d6904f1628ff4f71c9de665a31daa20929785a1c2e83b1e2ecb3391a80c5b2fba970e0abe8ba7547f0ddfee6c7fa73aa2ed5b1fc1c3556f6c1e6c19e9eccb250bd6a63fbf7aa07c3858364ed7bc3738b1eeaf991535bb6be1a2f30810b77014c181289e4a6a2f2615bafccfb9904708ae88afb597b0e9bb5a88d69f613a2acbdedfb067f370099ff1cd651e9e34e55c8d410860d4ad5a8662b425b000efb3716721c9945f1ffb3a789b4f3057077262495962b8a7dc44f469c868b3c6001050367ad2547e0c18489eb96d5091fcb6e88f139cfc8d9218cb7045c72124b0d5c319b721dd4f49cc7773e77a22897044ee6e9237217e4e480732c7c9fc86551b50f60ccda6494c22e38a01bf0ab4f98c74f0650ccc529c8d9c10b95f244687ee47e1b85163d59f1de72deeeec38740b537df7d77dfd18694c7154b14140229ec4279a70f9a87e4dee191cc56aa08ed4ea831c2b07de5c47a44cb4dbef66fa5c7df55e248d725b58292eba4d1e323c09fa802ae7f74a2b7564d0ef3136c27b47c12438c66e91d2cdd3af2b14c7603e8ed000425b5c4c33e981b10349fa410946874187825a7117de5329b32e31eebbb8a4e831e82215e1041628d226fc3706bb978949b5290c2f80580d7bf64b1bbd78e4ef66bd8666bfdc207c799da91c848f7e0b1451ae6011e79ce6ebbe57be579e0f9ebcc3a505ed6c6281b680945e25e9e9bf6c4d057ab582a1c77ae0cc21e373f08e30c17bc7851cedf82867364c29258df0f7bdcf77c883966b2ca621e1e579f5feb7c54a09635a2a7865837fb8ac4c8b02a629112bd71313e30832b19d30b9a23d32e54bfe990bc784613a72f4a762ac7cebf20974d887da7efb19076a7e3fa61198564f8f59d14d8dd16f75898c86864b9c8b83c5e12cf660ca5a6b9d74654598bcffdf784a87b03a291c0e8fbbae781e106fc7e93b5f79e1f1d2968a49179a44cc6ae7e561f80619a5c7ca7c0c8ea42febbf87dd71e3000b79fdc768c8ac4862ecab6c3670afbff8f5de5989583cb11f0420677b122940ee38368bbb20d8ae7fbea38f1bcbea0d1e670ae3e127d28b928f78935b5d6da558fb3950e7a4922053cdb9b76e7f48ace72327b1ded8904eea409010e741c27235bca48a636425f0e25713de9886fcd8e193fc60d458e4e5b90032ca486c6ddc538d941ef8dc879f68b099923f4a515ba9ab297ef823a650182ca157b6163d1c75a56a10894e6f0e77f70b021876c1223bd651b4b0d18a10cb38e01d48bdf0e314a8381c636acae1ba85c29eab783deed279c1e7c45a0dc5f3fba0995965095e6c101b965539a8043197953f3447a4c301c7757b6f908bc7b8512da418ef8b725e01fb95a99ff6c0c54718520f91db6240b741eff36dca09b5dc223c0b602cf75a4c0afd0ec476cf25f8546b91adabaf5f46af85d2fab75c31604843a7f23d2473b0ae96a51ac6701c58cf90aa98ed2f5edb0a165ec31c6d405e071aaa4f425e08e3eeba85b56724bf9000b7715be1aa3daacc4b4da204f97c71487c79b6dc0afedec6b4df5d17c5fccca39c3057f41c29633c1c9d8d1e3d6f7ef1dce5106b2beb900cef8ad56606e8981a04ed8c1d122f47b4651d7bc62a36c3b469aa4184b34d4111b477516c0b184eb317dc2e4ca87cb43ee239942e574225e67c50ad5d8a4c3f51afa6579919f0b53aeb10fe850380fc4daf3e6f745cb97d344dbaec5f071bb9bb2005800b75606e9bf36018e568fb866dd74437c068909aeda802e93c4f04bb729daf02535a63d55f41fef5b7ee91e26407366a43387518c7a51a2fc18cf1bcc0906a9be318c9a3b6e3bd8a04d93f9374c2a4fc0aa1a8bb70d12d5fe6fea54b0119e42dee284e93cba37d2f2cf28c681704bc02016baa62a31cdfe04785c63650e810b8b01d192d542dc1081dc273cb8127befe3875c25e5ec1358ba9df2def24abb06d55c715a5e6a64b8f442bdf0c63b5805d556929c6a447ba06d4ee2070cccbabd32db67c3a74d816268cb5a60933f83920eafcf255c5e6827a8c6940c7d3cb21b3eec1fab71c6b2377469502abc49275fd9a9fc6a19046a1fab5d8a93260db486558c88b66302dbcc619a0b39153213f3f5d93fb19e323b8fe43badc6590fd1ae849f44e292351bb9e0f8741c7ad609f2cd0466be8200c5f87be51c27b7df77ad4bc0c01b2891ad21c17a2c529bf2013846186797c9b91fc98026dc6d8268629d743b2bd1f60b4308a054a01e78d6af56d936ea5f2226651d0519cdf51bb48a5e529587dabee9ce3cb6aef2708340712cfff6ff83a3ecabf989551265f5660435409133693fb1fcd2779b5236ede774dcc36cb27543e89aa033ab0a62b30281f28a27091c9c3564dded59268182ec7555d168754677c67acd372d3e45ddad94ade1e16da6d2c540853cdeb48b5ca5116115de146e6e99a61ba6956828f8572fb033fe79d78dcef8163201966889281164c96bc77475be2a390261caed8de2897e3df17be7ea2e7c172877ba09be15a55a4107b228c9e0b81e86b1a36e174029f7f0e60fcf00090064cccb1e3b71041034936934c8c498a5e866850cd5caa9ed3c6ab228f7f021bb4295435ce942d59dd589efd82a9ab3759e4c0a541d845b30002beb0608aecf3a4d9a63fb3487d9a2bee3d533c15b22d02e326110421113e25b365b5817035e1605d8f4f40ba6b7fa0bf1d5b376fc2d537480a57c776a1985236a63cf88354e4574411707c3168428eb70ca7aecea7f474e20ed25dc83baf4f956738d4342f43af5fdddc207055d85e593748846388c5ea7f7f6d33afbfea6a3d6b0fddf5ef9133327ddb05d1d38a05c74aabd27a497c29372eec74ffbf230e6cdb3c3800afe8297d84b8af"
        )
        val state2 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, normal, TestConstants.Bob.nodeParams)
        assertTrue(state2 is Normal)
        val normal_with_htlcs = Hex.decode(
            "aeb9d629d6dbfe8ad99ac7c52dc7d2b42026c829d0cfb58bfef951703bed7a6344f5a69ad4196955ac11fd2f414b51ca69f01f8b27025f59d32b34762ae4f5d61318f99a85fd08e1ddde140061577357c0d214671e072017b51d7c57b1f99b7cbd6ffc5349891437a4616914b06019540245279bd4ccb9b02dfe53180d5aa368af8b629a3963c902cd70559f3cac5d1f1cd120afbcea27a8b3b9436a726c1447276b3c8b9a82f3c46772bf8be45c8310a710010fb305f7ec42a57866dc5b43bd91b5b3559355414ee0086b539a96046669932001e77d2908cc0d177e966629051aac5d91a143971e538c25722504682571761b4d7ad9cde07a6dc9f859a93c3763e7aba0e5d8422783c4437292d77fa2ce625669d8331f2b36a33928b97098eaeea7f6521d6cf62ec2c2c62903b7c59aa8119cf1581eb9189655ec364dcdb8adce011958e9ee5b17041636972df3c1fda26e158862d741942fc82a411ef0703b5da794721c0184bc263ad24f0005439064680fe8cf566e750817fd4025df44081f2cd0de2dda444a0b5ab15e23793abe961931635bd858a1ee0af0fe24c352b1fe7e5a7da1a5564573bc4a5db07441342eaf80fc5ae6bcb6d02cb11aa5729ab74d2bf6d59d133432cff1eca14946b3e9e927a7b7b17f0f63281612c312f5d7aa22f9d721b8900917229a4dd94f4233f4e99f97d109b19ba7d693cedb7c041b909df72e1a5e3a2e2d1ee94b023f1684a7385e294cf9189039bb7789a10a41cdca74a430c097a1bb63098ddf33ae3dc6ce59c1ee4eda19d8ee8f915d17528add7afd70c8b1c610c11386b16ea27b61534369a6b13e1bd832157686b5ab198d74bacbe106bc69ea4405e4e90524b74fdebbfea0f8ff12f1ce8c4d61fb9d6f53c8d0cefab47413e28c217c2038dddc4d9e1d615d0f09ed21d73f166ac6d039ccec25c2d6560b89324abf543051e08770cd327224d758d844c5b0132586be317650b371d97c3130454b3cefde406b00849d35b7020bf9df7ef6e78eb7e101e32a61d8f67cb5fce43e67139d6f112c56b0e29b504cc2168a12b03f884e5c9b756ca533a6cd68f007028e8dab26c11ab27b8867e8964bd8efd20bd0947cdc541043151873b9b66fb9d6f42c6bc8b6bba253cfb4083528cf7557a0f7b35645bc58f56d1c30919ae4f0bc9694d446afcd1c40fb28ec3785e7b560d43210672e088020731266f8b25752bc480b44c649dbf11aa56ae74885b53c93d1d8cd092404da08939512686188a8cb05982881d4d041791ae0db6b129907bba4a55dd6046e6455c9f73dad6287a44405001227360e6e0f9ff7e876bd361ad2bdc5a1750fae0cf2518ac4977e471653eed6de79885845e1c6648741a6ac711005863a7cd0c69eb7f2f033c985d8f81f56fc4f6d732475e1c88b2bca968c94d95521955f059fd73833f0e6818281fa8dff36f22813d83d36f4ca1d1d5eb8ddb860d5a41973a0455fc8cd683c7eed6136d995af413f5b674f65e0d3e81173446584a5e196a453dd71bcb02505a534c444583c0394f48401b09e7ef657e628112e7bf1a61a65d44715d43a10f5ee953444df4174f72544f9678c37b0f5eeefc07048ba3513d261885911336e0293e180dbce22cf808f03e8b6fbfb8c3eb3b03ae135fe6d6fa463808d0e8a321382c6991fda75da39a56be06bf17fbf8ba8ce94fd24ea51ffc4af6fb4fbac5d5f819631b78042c62c354b2d63e409e00e8f684ab12898b6471dd41718795663e9a5747a66dbbb03c1a4f271b36a64a0b03917975b849f3986cd1fbd31d5b8f15d0ed03ed0beb9743c5cba49b9b4cbc6e88892fc672d16b8ab36c6c72dac9c1a5a1367ddf6240d671aef4874385e0732e308fd9233ab53f71d824e1274f4bc54ed6314f69ea02000d14564907721b26d6e4ecabc142ccb27d85a29ad8046ed3c143285dda3a4142cb61c3ddf4519d85fc13668ef1b3e6f1152860e14894086c86ecd8cffaadb8cc9fe77b62607a19cf2adcf3ec41de5fdcb7495f5c90b6c5609eb584e327b14ea2459b37de78066523e1d736d372eed38727a6903298a0749376b206dd40b21147bed9d19ce467d3f702c38ab700446c67b4bed47d29a05737c7c0300fb994eed41165b61023c398a19bd772e1ac50e76460040e16ab92ac891798a401f0079b8e5bc62caee7a46167d048396c08460484098590283b5fa40a01ed2dfb6ee116cf31b4b326a2b7cb42af64963f6f733ab617c1deae36ec2ef33e9e479446c82ddf576ebfa120742f8e2359a0b3aa113c5e139e1b7fea6a89cc373f095951b67c48cdd5a2ef7e8ae421016695691650c9abd408b10efbf3486dfa1700cb51ad9948d3a1151828766d20460ae064a98ce874ee441fcbaad8aa6291db4cf2505e7a66733d8aabfa36c2ad23627405f86ebe002b4a4c5fb8ac21534e7b341b9d722e7d6fcaa8ad9aa65ac56718c713911dd3617ea9c7c56140c03d7495dd252fbadc112aafb7736c9bcdc908577c38029a4501d0a789ce19bb705b060c55252b65b9bf3f88ffaef275ee882824f43ae90f52eaeb94b8ddda642b592bd34447c24dffcd70ccfbc08ca73f7c1cc914ad3c9ceb53f0c04af217063b6407bd906d818a954ef3b96d83223197c557440df536dd62b192571036b065e436ab63d336606009051cf39d441bc06e9804b11c7c8b432dacfdc2322f832237e2275c6020c1d3efb03cddee00dc1c4bfe2f38e0eafa39c8655eb595158695086052f2751c1aeddf0957a4ccd86578f6f3a137fedc9bebbc73c1e861ad228521013b2a6d13ff7bff735faa51a729fbbcdf2d7ad16a1fa3192d152e485d991b837ff9432a6c79099f100180a85f6a0cfcd23d50ce7a9406b0e77c4e7ed61e82484be721214c6f7c7739f128cb6f7ea587a4b7e01ef8a4d04797e270527350cfa953aa1187dab225dfb0525b57adbe007bed4c71746ad9064f537eb0e741325bbd39bd8f1522e9ef7de7bb8421dd2bbf8856a4e9d9d6a4c14f7dff2fbc2e79be9757510176a862af08c7f6b6c47971f53eb27aad80f5c687294e84118758f8ffbe6d2b8d115dfef51864a02e9192501931aab66ed4e7b33450154c54527b433e54fb7c3df19ad34c697971771243894d6410d931e21f3f61242603fb0b60ee29ac9361f94eb662205d22683a39075b51e25afc26d8acba778a246bfa117ffbb3951b5411eb8fb2a6f5bd965d51a994a100340e0e2739f16702b916ba4e089cecd2deacd7e7a347b72d83843f2bd3e424d53588095829c8137e6372a28cfb77dfeeb82e9ef0e66b55a845ac3577307bae521f07e679db03cc24d7be8f27ecdc545bc5abd31860448db9fc34ba160f3552133cdf95fd68ebd6b7bc0c1c17cdd5388c14ad80ea5e071764fa30f4ed4c34ac8306004588771794b038205d00637a2c0982302f8db06e8f45fb07eba9c14d65846c1172a13a93d1c738e5488525a68de39ec89fa7209df709ca0d6713d4182225b01f4a3cc81899319d0c97603c20ecd159823ad9b643563b628f895cfa73208a2686586d2b068fa4b119964dd9b20dc16fd8a4f3da7759847d1dfe8aa46cc29a8b5ddc1bc8900fba5b36887f6b19f5f9ce13ae61f374b7bad08aca19a5926ad7e9af3c7cb53a285130d248b944b5146c9e56e6ddce878d5c20402f425cf102a66ba9b314843dbf24783eed0abf84597261e78a544f02a6e78e310b4b58775d26b7ff8033954cf8dacd9f34d017e40fb524acd40a138a83e3ee05e7f015bb48f2ed1bc146776d84cc37fc094c93025561357d7a7e31d5d8a79cf0b166209b9af3a9882b2f36f56fc5712016dfd0bfb4491b04f14a5c82e0386887c624bffd75e29e9ac31df740873d4b2677fe0162d5d28a906792e2a86a1872dd8fc38d1bd0a2bb9f1dd3751fb993a3b2b57a94fc3b45413fe746f2c8ed1064542026345081536ff05114a30d3966ee81861626af09a6ca4306e426e4f94c0bb6f637400376e238944c1a180efa1b677a068ebff76960bb5ddbc1549de4861232e0bbe9fd2a5f9c78137574f6901560ec5bb743a5833b94413ea5cd23f277a5c87b8571a9534444ca93ca61c2d86c00fbc899efb33bee29db5c53073edad7cfbc9645f8e82c777c03cf1c859e827f96d5cee9d438aa87589f5421347c2298e10d4960f83889f56a24216556f75899e497092a3c469f71831dadce5d11ddd4dfc8d21c4aa1a2c6168077c27249db6aaa7a709e40d9da37c189e351b9488e022a0a5bee7b89ea38e60f3eacccd8a5214d9bfafa64559d583412d51c9b1d00e180a361be09932d6c7abb9474396063d0a67a2d0acf200042f237718b39d8794b821fd40ae5557b1439e14c8c511c97560015b9a0a6e12240eb6f16a66705a2cb45b194b7ba8438fb4eb6b2f8b7b3d37d1ec1b22029a3ad296d8a478187b2247a317351822e3a4b3bd05c85be9bdaf719428174f908a8abb4d73b0a52aae8465d7731a962d073903250e8cb7899157ba6c00b0c77c2632db63ca5ef386af4572c3252d31d9ea72dd7d6d0d2c33c53641e4fede72058f7f7cb9b4b1c630ad0919574c5fd1f787af1f6e74be942146090303a8e437c507c2baedf46247121d44b0e55cf5914cd144adbfa40b3689fe6580fbc29c452cc0ede828b02b4aada6bf79f694a48e184ef320f72ed7f42cc5799e8d97640c57fd7d5087d0848d903fa55f5f2e22bb5398cc7f0ad889311a20057035b94b7ab45bd3fb63326a46ced9ec47440ce99746b6ecd8509ff3cfc33342879064f9a0821b17bcfab25f538cbe9d741e7af6d88a1965c1730927103963351300b72f92a1aa86c3e176fb7e7d327acbc0428b791516e9fc024466bb5807238ede36e093d448e8233c254c4540c95bca1177bf494d51338be1be2825c2e39f7b543bd7038004d1d5936e08b4a3b69c26fc367c1c9b80d741deb9dc18885fb9d1dce77e9b69b1ccd71f0816e3d8c68ba53ff26bc1a69b6df2528ad4a2ec3fdfc68d4ab1b9e7c3067685c86595128aab707b649090d0a4604d658a76cf7ed43306f108e0c43bf10ad37e2df57cc4a0d80d5af0617c79936feed8b54522775ddfa7172c249c20f1fb9323d1319084a71109f7eb244db07d5562c954071539f548a0a808f8d95f00291e328269d333af03d9b5fdb2728d3a2474bc92d17d92a782c70d0ec6ca8fccb57459d31f0dbd6cf3e22c59a2720cc86642c594c5f5701343440ed309bdcc1cf3f9014bb8a9ad2c3a97773bc3fd5aa007840a26d19909ba59534fbe86f3ede76ba73dc76307151c60734293f283de4501127667acae6a61a1b2f6ba7181300d18c0d311d063bbb95dc5cdbc174f02213a15d44662b082bf79a7db1d2b94e4070f10aebcac6796478d7593f83d1cd45e4a166b2d1cb9870121b39d39da52c4980de921513494f517130b9420fd999a813a5045656f3250e48bc760880af06963339ecfa819ce7610fb11ab8ef492cb08b5b16e93acd1a49e6589644a3b54e9ca4fbede016dd03e82d2d08d8f88b8bd95789e022548bf9f1dff0ad017ad8d1fff77be91d138a3ab274d359dd19753b553294defced517578f37598dc85770df9a7e3a092dfc3338b4eedb269307eb85549fcd2174259e79bf89acc0461695450f3ea0d4b4fe3b80d12d89c35252e0c7559927536261be518b74cdc71ae4804b076273f78a905c052d2e68e408936f6f7e5b5225a4782c05f9c9537bcb1da0c60882ff3b11ac37d24cce60b1ec5223c038b091ec8cf2b3ecca3109c266c655382b35b961c6a96cbea2a8756056fdcaeb62846a4e6ef832740cc84038bd53c36c9b7438a05c075b7e3f7f30d5cd1de021f7b34a65af2fb9601204e1823921b316fc76374a344fcfc94395e82c099be921bfbf5c3dc96ae692ea46e1d6f9c23c6fd22e5cd126117753b27a90e5bfd4622ebdac8c6215adaf986256d0c8c7c84866beb8b85877f45c3356821745919149d1f1a2bcda62a396c29d1cb7de7b1127d463c9091c31c2e7fcbc4ed1668fb768110aa3974d8b95a4407f6c6bbc3c69850436cb41a8a8fd122b3d20b06e7283928ae09fec18e15b77691a4eba2547c57d60b93d476885e826241b0cd41733c935ed6660184c7cc1213d1f980e3123ac6b80b4fd65874cac1e6ab359e620c4697bd5537237363f385d3c5790c00aaccc85c8acf34a98cd19e35b3acde1b516a020f9819cd21d52584e33c034df6c7edad21e7b2974f3a811ecc40a981737930a4cf1507e234830dcc8fc1524c03c826f01b56eff25a5eb7ca7ed2f09391a05f2df7385397923b54cbb4a7f5afbb3aaf2ab75646785420bc03acbd5115a2c5b1878f9df7389ac56169e5ef6d8f562f3914518e092e3352864887949a7a87a552f35a0de3c1e81e894444bd6ed7eac5ab84c75d62f2c6cdaa964c60936b4542308699ae274b902968e99eb48338c8ca3dd0db9d4445df56c46d26c702dcac37071dfa0e05a6eca496ddf9c4f27b27a1879bf0627d8ae103c717dd8b817ab5ac8f02c741cbcf74870bd81d9d3c63503a9227f4a7a7e4e792c6be18c681896c516e5fb46d39306feb1c2b7df607f72f5ec4d9deabe1eaaba443e83a626c3850cfe6b7a5a511c43efc5f2405a32509fe7ffd95e66bbe0876b436799c31d392bbe5406de555ad51c0180bae9ef7d9bfdc6fe0fadeead261fd8f6d779c30e265c6b036791e23a48a3744fd95ef49c48541c85a8a27e08e49495a88f1c74f0d01017cb27374f72eeb9c89b258bac4a388542d9fd8c0c31ef2c26f568e7210ff668d8a0ee3ecffd37c16175bddcbf1bf38b5b8e92f7c1a3799cc53124b9b1e9f7d1cace357a616503a284f48005e6793cfd224268c7a32db2179899a8aa3c556d85666208bbc1caba4957571153012326b34a01ed32eb7ff48bec590c910a3261d70938a00e9dccd71d6d49ca9c82db73a1e686bf9a516e0aade0188b96b82c1cc4376c3050b18521a329b3456e61e24f8b3a26b36a2c9d96acd73159fdb47675f2cb2b1091c422e7cc23ed0c6d500d6c6f40179919746b47606284b5364d6f79fd0ec7a49ba48bccb6387fdb1dbb6a6c93a56e76cc9127ff37e1a2009c7e3d214d9922ce934333d9d6ed23fb289829b8e83628979e2c3e410b84676632fb5b470791c4efe12efe1d4c74b9519898c8046e966c3d13217687c4401cbed29e896cfff21c5b6598255cad8ee0263fabd62ecd478e571e9b30d7ace588ee8c426d9f758c9abb1a642992ecc321f55a14be4e168249f9dce96ce16738752e47a9d39d5bc871ae0e0acbefc5a4abb743cc198e28973e07bd9c35c673b50c85a2f29b27d5b93154ded543319a28420d96333147768e6697f91c2ce00ebf063a92c302be21e606d48c9852bc3d62aa18db8eb4e6ce0588b0943cd0d7c376cd90a993592f21798c7dcc6d04a69aca6e3cf431ff64100301a2c07358c01dac4eac5702bdff988f28ec39237d6f391d2986b9748077513191c4beb8754e613efdf8b55092dfe37cde0b804c4e56eab36e89f641e631f01453e5c11a640971fd445d730bb8c057d3424e47e5cef964c0f996d05ab88835471410a383cb0ea9c068cbe835963ba0e3eb19eabfe879dcada42493d62875c1b59e763c71e489026102231950099c2d782f1fb670508926cf9f4dfd16a827f19d75ce63550703fc36ea1cb3b9c39bed1f103c940442f3f7ccec6a661c77d2e616ff97eb93fcc4e1bbbd2795a487edf46f73fe5faf166ee8cb2dde2a42387221f1e44efbb395ca27eb421f5e3888c393311fe8283d6955af13c5e186e6c10ff5d94cf74011c09aa7d5b52c1d5d0904102b8f0c11880389d01481fece423521f605b9f9f161d5d5179eceb55aeaa4504d4e75397a45654908ac2c1d5ea7c190aaa1285f05a9e71ab65ab0d8354a602ce8baab59a005c55b0526bf79aae24ae83c1eb1e88dc2342e9534af5a145ca5f1d2ed901137631a76ecdf4c1eed6e5abe8a1ea14f07adbdf092068b2e53b38755a05ef590579d54e42cfb06932ebe7ae5844717277f0841d189268a5290f31c0f9f4d9195f749ab5a339c6a1610ed8a749c7a1e8060bb3613c5cf8fb1dcac2ef5bf4c41b5aad88009d4a3a65da9021a518d8cf13cdad28f9b463f4bc89a3fe1312738c292e000465663add8ced895fe605e5318c327c5c1232ad28de4d6cbc51736dd725e3001c136fa1cbcb11b6a65fd0269e07b154807a7e913a53ae9c486013bf0f41293ffda3bc58d853dcff6bba1ad4d5d1b7959de574f5c0a16685bc360461f35e91807d4654812ff023ad6106418040f8ec72627e373eb9b84bb46312b7c25c9c2464705896c128dfbe072d4362af73531cf62bb248e7a977b72becbc64c9c5249de67d8b717928dd42e63e71ce6691ac27c10711c6a7383a7748e71d9a31421ecb608e597c411ffdf5eb93f3dcab1d29cbf00656af2f10a7b1fad4c2327c49fd6c1bfdabd819a94c421bcf8925257bbbbd95f98fd57cb7bde583ff4dd5c79fd03c397dc06a64ed2a3405500bb4f57f8aca3130192bbcb43b77126a35190ddfc99936f2ed287d1f13c489da36c31a3476f03fe2371410cfc7b2fdcebdf79379aa8711cb68306151e5fc2a99c8df33a04c775b7e3704d40833f3351dcb497fed6b54136e4f87f0d0b3ac45f769926333884281549aa55642236143109d658686726f1b1e9d2416a53786485ba42c2220726ba46ee23969780a4a921975d6e2a3a283a7d3a8bdff6a8f5df45dac78166a9da9b653dd2a8ebcef860acc29cfa30b29845bc1a1273de9c71ac4fd9961d39907b27e38ccdbfc22442214dafe1733cb6c36f8bc4396bbf52ad44416226e750641a41438e10746eeb08d206f2ae43a0e102c04be6d028cabed9589d66a81e2f98839e55a3e8c581e6054e54783ac31c44476036c484f867c266c3cc3ee3d2896d4268c0d8ed6cc58ec1fbaeed11d1d4a5e838992d95d4a9f86f85bbff046743b9693830600ca2b12aca8ccae05310edbf0cc63ddbcabb6c6698199ed7308d097b4a2a19f4582edada14ae03a9d567ced0a64a3dcdf280117037c4512a08af9000107113702cd48fe68dcf9304543a18cec67583cfec08039e8b84a33e6b4427d06e8ba119ef7ee09cafd4274b64a3ca98b59fe0749dd0ce0d9963b260adc5a80c89ce915e2b4f7f293a05afe005e4c3ea471c836fb24ac6c726b4e5936ddfa589439957ef4f731d94a67baa98ae62a02e89c4cf6a565f3c55300cdd86e436870fe39d89bfd9a20dd366cc2621d353446570fb2c381cb417fa936a3af3bed932ee7422d48b603f2ca049beb9167c6d3e95182106df0a856aeb306fe6fe4cc45310715a1e596e1544b2f5251d4651787c05b1fe7539059e5bcdaa673dc99435ccb2e19b516cc90fda0ee8df873d391270bc2278dee04110b00225ae9aeb92f5499c1f21b9f13ef968101c02f72df2b255ea54083d038c567487daad422e14955755bc5d900ce878ef70e6903ff881ed120a018eaf2cf13acd840730a02a530a816ec411b13a707100fc7fd49235299f808bbf0ffd3fb86d7227863ff54f884a9efb010004c1e331263bba7093fa240229783f6422d8bfdcf49df5399144230f0b81d9181f993f8b30f8bc90f0687ab08fbf4d2cf5cbd015b55bac3f87f96d8fa0ac7ea599c02afff09b1d5f32d43629712cd18837808ff5a6d9c0a59c304098f45da2bca652e196eb71c9ca5c77b9afc8f40b44b474a3f7c2e1d7fac6708e36fe932be2b4fc009a8f7826e6b54fd7d9e7103bae6a42e116ffc9660562d7a56757424a0e51d788b54ae5ae897a52cab2ad717c996e01f46ae054b6e5f114e7c8ddb28d898fabf058f8ab8f065f61165cc72de48b0dfe82d7efca220adb37ca4a6fb9518a04322314f6637ad9058f33ed7aa0fda3c3708092521df11d979e58f3d51cc0ed629c357a2ef37fd858fdf7c5dfec82c89ee0405117bb029b0804890ac09a77aa6ca141d0ed48afab620358be2f39649c3117e3a6f02fa8cdc78d7011419c6469b04e49f50712f3f867ae663e73c9f6ea6cea56206c39a5f783a8f07f939437f7fe5a8506ed904fcb9513a9640514a5361c4f57edf551b2ffbf2ab6482d6c9c7586b80eeb080e5ace8e0b74b9640c9c2e75e3076509690e8f095892e4c784a926e8b9a5a6c9d7b6af9b59895ab307fd37b77e0f981b88b45fd07ce5cbaef0c27a2cb0449a45e68907be6f7d3db9818e8c29b9faec34f7b6e42e1fe2123ccd4a3d162c94d735e5da748378479b1f9e6bf71a2e0204985d9747b5f15eea20e05d2a19999be5f434346a8fe35189c394a0e5d7e77a33dd5c5a3e9f42afa83cdeb7b5e09266e7e66bf1b7a089e2bdea18964716216814134404f7b638e4df34c861dd1ce61a37cef929e384b8b5f410478ca2d3e146c17be0b1b8e980e30c10dfcb5f9d65c7642cc61ef8ca2ea4855b97fac5c8e15e534e6c956622b50210871169f4d2c66b4b36f2c82a8b7c2c8177053f778371e642f562b8a73075a377de9bb4fee8c304adca440b1f2c8983da78ad45e95d0284c7e52a8314ae4ab65b31ade0b66316c5c6b2856d026497874a1334b1decb3578f39193298a3963fc79a0c036f8289b984ea46e2a4c2d567cca6b94b62bac48c552a916067e2687eeee84d728f7b83a46bfba917cc0c03eae0c3e262810482ff2c9bdffeca786bc4f675a5b781a46b8d75ae05804f9250aa09b95fd8d4d244ce22b8924411fe5562fe29284355af4e3ecff615fd654522ba3b6fcb8d2e86a1d1fc3a602ed7dc0c51bb32d7352e72e32cf229d95c0ea074238da08d336c7536f5a7d65ece7ceadd8063726171b75807d566a4003c110934f87c3633633cf6c30487fe24ede6938be07ed66d4826503c4e5c6aae301d2197e13151ba7dfa89c9d8d331e90e94927fcba9004fe3c36f3d08c026e2af88c08c8f766beb3e07a0e9b826fd63deef0e0a5754dbbc12f07630261a75ea23a962983bac3d30dba628956d6d3e53cfbffece5d94b089a3d2a5208f89f16eb2b8920761220b7906b487ab8f032195eaa89e66e22e7b79fd6e1363550da3f7b4a1dcef6dd65149e4872d1f175e5fb3b693aeaa729e8a13b21843010d08654cb095f47bd64931267045d5139bcbaf43658415e16b357d9522734d14c03016a0a682ba7cf2649a0af62a203e7a1d062bfdd5712ecda8af790906b5f5d062bb2ada7249b7c037e715a668dfe955eb5a509bd470bc0552cf90244a33254e497e02299b252384c9a09eca9e52c03fff8bf2b5b71f56ba7e57e2a5e184ad972d757c100460f6f83ba22b017e0f38dca03ad1702ab5cf333268612262c3be1e07d237d9bbea7c473adbb7dc927582a132aa1656ca8bee39de41ab8bbe7f263d90c5077d090b685300034c2a139d47ee3d78ae038fe1b8894e9df8e168aa32eabeeb803514ed8770f16c2281bdeb4607e090c2fad1f16feed54c7682086a6b0284209dcc1b43a918a1ef31f81c8c4b7d60660ea978faa534cd73f92373f93843cf304d5e51b4a8c1600c99cd246ae2ba1486153c8c826acb5c44be11cf5004a0545a37058495276c46fd047f5c9a46b1a2422c437665ff78b3250c4e02cb23e5421d80e4c2f18c5f795eb7871730090bfaf870de483ba24eca8ed61ca89c858a6ad468b3cf9439c49a0e7cfb684272263a3ec899064a8e390baac45f95c0047d2cd35ce72358cb7ae13b3ca11619b36717ee05b4cf10c77caa64627d211f4833f52649f230621ed4493f0e955bdd5a6da8114e806b2c2dceb3233fd021e910429d6d6408d4b8fb33c658cd9a7231b6114ea2174169d6049e68671bb703b50b82f255f0fe70388e977ce1b239d32814df27ce4837a33dbba6635ed2b38dba0541891f03af50b378fcc64c4c291c900c79708cb94e988729275942d57aaa621d4b8dfaf6e9b6a85f381a819bfb112778edb4d317ac3ecb2d01e10c54b436458ff4901ec9954f98c91d63c6b12e7de2839801cd439c09cc0208d789759ef5061beaff6cc0827eaa002ff9ef9590263ea7ea7044e18f56d289c29d5bec3bc058bd730bb05603b73e6ce09f79514c14bdf31912203c4771d09881a2e3bef580c01dcd152b8b6ab2c41bb2395f2abe74d7a2d12da3d1db57fe06cdf6c634710929612ad58d3203c586912a138c323adc886fcb2b38fd283b5ff21f455af4fdf84e4e2a4af15aa0f3e0266528283e2322d261df5fc7dfe22f4113c2333076709042bc2d20d28a0bc39728341a293282f8b958aa78e06ff4815a8e8b5aed30de6896909ca6ac7d879115383201649b2ab5b9edf32172f89aff1a1c71f038e9f359ca75544e0dcef254788f9985eb61619a183efef2d0a9ca9f6ea0b722c326cf29ea3b0d108eec1d05861814a0d389153db3159152330609cab28afd37c1ca1c66e3a2fd9c643aa48b2cce0114a4ff4c1f9888c91bc5ce0d49838b7d03f5c988bc22c32f845105c954c791274e2118955b262a173f461352a65d57fca4fe0d2b7833ccda26df4950907c7813b60362901eacd3a3f7b6d68657ca5842fab25b3350bfec2f437ed7d3d7db680ff6d094f15db7b79c152d1aade6aec26db5e9b9ce6829e8fd8efcddc2a58c8e9deb47d799075f05b1042f7d8f6d7661883c8447a39e36f96ec397763c18263a8b411018edf447f6630a1dd0ffc90f6dc43597e66ff8bb5bce998c06b565ef6d9e587bda9c26445e616b4b3caccf00cefa53e4790c34f87b3db2ac7744857863f6995934fd2e797407c54a30f1cddec2f049a3d5a6bf0d116b6ca2c2fc2b7d4b1f6a85a0b7a964186047b7f2059e69eb256010308240265299113e527b216d839d888665ca58ac26d682cf314df8de7ede8c85bb8af68ebd22f6f4d4a3d71e21b4876efed23a882ce0a223a5dcd1a32639a038d8bac27487ecc8b0298be6a4d4334da8dd9da0c5f5556ced6bfa2fa5340c32a28975bab415a9cf43897f23a0046bee392c9255968b4c987e4c69776a33d8053a4f051b664ff8d48e1a7689c769c1eb87a3d2f9488223380f22738bbaa1e384ecbd920a61e18b8d742efce272262c79fb48a6a74cb1ca64602b512cf28a5f3fe53231bd173fe73c7d74c6a1860130f6dfb46432d5b8b7a9d267ad3f4183f9350493c376e4553b5ccd653f44cf7613d6ce8d534bf672decc48ebb29487d9547d255dbd7edf1f200e12ce4c582f7f1b4e0342b3296f82f10f0f3fd1c935689f79e43a3420b103eba83b6c9a237e5f1c6a5800590134f040662a161b59c3d7a225658d7104b4e907b61b57ae9072ea50b52e1b4ab5f1987587ff2c49a2e7cf51982eba5ec93eff960c52214aeb5eb623029e2a4c1d18c5f32e130913385078bd76185a7c8dc45676389cf2b9567fee2736da026f5367503711743ec145ec481200ad8a167a2e07cfe9674d67a7cf2c105e16fde0ad20ebed924d66a9bb05e56d4af20f5349f380ff2a73d1c083b70b08b7028d93314279547c468ed98ad3ae47c0df66a59484ddd95c859b1077e54d8e9412aff3b3954fd52bf26176ba1c872f27a6fbf0b3b0d9371490ca65d98aa153f1af62f32176a38734a0f9816378d61c052173806c39ca3c1461c0932bb74afd499466ec186a9574afe4d5db455fa5be950c3b624c93808bae2cf134ff5157e4194e9d006f2792aade98a10c1590874139a978969987e69570ddd3a77552565a6a963592a169509ad289994b97aca7dbc3f80cb3f9854ba613a549223415e1c2b61cf553d29dd43f0e777df1c11319ec97e4ace3bdd0cb6d47dda71919cc384bb06cb1edfcac805372d43b86bacb5802e19a3c61cbd22b225cad12586bb894d060d3656f785a6227cc84cc970692da3740a1573dc64ba5f85edc30de7d6e2286361c919fd45170bed0d6302e81eb11430b922075fea2855f91076a3cc"
        )
        val state3 = Serialization.decrypt(TestConstants.Bob.nodeParams.nodePrivateKey, normal_with_htlcs, TestConstants.Bob.nodeParams)
        assertTrue(state3 is Normal)
    }
}